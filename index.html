<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>SocialFusion Pro - Fixed 3D Placement</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Three.js Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- Embedded CSS -->
    <style>
        :root {
            /* Core Palette */
            --primary-color: #007AFF;
            --secondary-color: #34C759;
            --destructive-color: #FF3B30;
            /* Neutrals & Backgrounds */
            --app-background: #F9F9F9;
            --content-background: #FFFFFF;
            --secondary-content-background: #F2F2F7;
            /* Text Hierarchy */
            --text-primary: #1C1C1E;
            --text-secondary: #8A8A8E;
            --text-tertiary: #AEAEB2;
            --text-on-primary-bg: #FFFFFF;
            /* Borders & Separators */
            --hairline-color: rgba(60, 60, 67, 0.18);
            --focus-ring-color: rgba(0, 122, 255, 0.2);
            /* Interaction States */
            --hover-bg-subtle: rgba(0, 0, 0, 0.03);
            --active-bg-subtle: rgba(0, 0, 0, 0.05);
            --primary-hover-bg: rgba(0, 122, 255, 0.08);
            --primary-active-bg: rgba(0, 122, 255, 0.12);
            /* Shadows */
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.04);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.08);
            /* Typography & Spacing */
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --border-radius: 8px;
            --border-radius-large: 12px;
            --content-padding: 16px;
            --element-spacing: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; font-family: var(--font-family); color: var(--text-primary); background-color: var(--app-background); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

        #app-container { width: 100vw; height: 100vh; background-color: var(--content-background); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        #view-wrapper { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; position: relative; }
        .view { display: none !important; width: 100%; height: 100%; flex-direction: column; overflow: hidden; background-color: var(--app-background); }
        .view.active-view { display: flex !important; }
        .scrollable-content { overflow-y: auto; -webkit-overflow-scrolling: touch; }

        #feed-view, #games-view, #settings-view, #message-area, #decorator-view { padding-bottom: calc(var(--element-spacing) + env(safe-area-inset-bottom)); }
        #games-view, #settings-view, #decorator-view { padding-left: 15px; padding-right: 15px; padding-top: calc(env(safe-area-inset-top) + 15px); }
        #feed-view { padding-left: 10px; padding-right: 10px; padding-top: calc(env(safe-area-inset-top) + 10px); }
        #message-area { padding-bottom: 0; }

        #navigation { display: flex; background-color: var(--content-background); padding: 4px 5px; padding-bottom: calc(env(safe-area-inset-bottom) + 4px); flex-shrink: 0; border-top: 1px solid var(--hairline-color); z-index: 10; }
        .nav-tab { flex-grow: 1; padding: 6px 0; background-color: transparent; border: none; cursor: pointer; color: var(--text-secondary); outline: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; transition: color 0.2s ease; border-radius: var(--border-radius); margin: 0 2px; }
        .nav-tab i { width: 22px; height: 22px; transition: transform 0.1s ease-out; }
        .nav-tab span { font-size: 0.75em; font-weight: 500; margin-top: 2px; }
        .nav-tab.active { color: var(--primary-color); }
        .nav-tab.active i { transform: scale(1.1); }
        .nav-tab:not(.active):hover { color: var(--text-primary); }

        #chat-view { flex-direction: row; background-color: var(--content-background); height: 100%; }
        #toggle-sidebar-btn { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 8px; margin-right: 8px; border-radius: 50%; transition: background-color 0.2s ease, color 0.2s ease; line-height: 0; }
        #toggle-sidebar-btn:hover { background-color: var(--hover-bg-subtle); color: var(--text-primary); }
        #toggle-sidebar-btn i { width: 20px; height: 20px; }

        #contact-list-container { width: 300px; min-width: 260px; max-width: 35%; border-right: 1px solid var(--hairline-color); background-color: var(--content-background); flex-shrink: 0; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease-out, border-right-width 0.3s cubic-bezier(0.4, 0, 0.2, 1); opacity: 1; display: flex; flex-direction: column; height: 100%; padding-top: env(safe-area-inset-top); overflow: hidden; }
        #contact-list-container.collapsed { width: 0px !important; min-width: 0px !important; opacity: 0; overflow: hidden; border-right-width: 0px !important; padding-top: env(safe-area-inset-top); }
        #contact-list-container.collapsed > * { visibility: hidden; }
        #contact-list-container.collapsed #search-contacts-wrapper { display: none; }

        #search-contacts-wrapper { position: relative; padding: 12px var(--content-padding); border-bottom: 1px solid var(--hairline-color); flex-shrink: 0; }
        #search-contacts-wrapper .search-icon { position: absolute; left: calc(var(--content-padding) + 10px); top: 50%; transform: translateY(-50%); color: var(--text-tertiary); width: 16px; height: 16px; pointer-events: none; }
        #search-contacts-input { width: 100%; padding: 9px 12px 9px 38px; border-radius: var(--border-radius); border: none; background-color: var(--secondary-content-background); font-size: 0.9em; color: var(--text-primary); outline: none; transition: background-color 0.2s ease, box-shadow 0.2s ease; }
        #search-contacts-input::placeholder { color: var(--text-secondary); }
        #search-contacts-input:focus { background-color: var(--secondary-content-background); box-shadow: 0 0 0 2px var(--focus-ring-color); }
        #search-contacts-input::-webkit-search-cancel-button { -webkit-appearance: none; appearance: none; height: 14px; width: 14px; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238A8A8E'%3e%3cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3e%3c/svg%3e"); background-size: 14px 14px; cursor: pointer; }

        #contact-list-container h3 { font-size: 1.1em; color: var(--text-primary); padding: 15px var(--content-padding) 10px; font-weight: 600; flex-shrink: 0; }
        #contacts { list-style: none; padding:0; margin:0; flex-grow: 1; overflow-y: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        #contacts li { padding: 10px var(--content-padding); cursor: pointer; font-size: 0.95em; display: flex; align-items: center; gap: var(--element-spacing); transition: background-color 0.2s ease; border-bottom: 1px solid var(--hairline-color); }
        #contacts li:last-child { border-bottom: none; }
        #contacts li.active-contact { background-color: var(--primary-active-bg); }
        #contacts li:hover { background-color: var(--hover-bg-subtle); }
        .no-contacts-found { padding: 20px; text-align: center; color: var(--text-secondary); font-style: italic; cursor: default !important; border-bottom: none; }
        .no-contacts-found:hover { background-color: transparent !important; }

        #contacts .contact-avatar, #chat-header .contact-avatar-header { width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: var(--secondary-content-background); overflow: hidden; flex-shrink: 0; }
        #chat-header .contact-avatar-header { margin-right: 10px; }
        .contact-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .contact-avatar-text { font-size: 1.2em; font-weight: 500; color: var(--text-secondary); }

        #chat-window { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--app-background); height: 100%; }
        #chat-header { padding: 10px var(--content-padding); background-color: var(--content-background); border-bottom: 1px solid var(--hairline-color); font-weight: 600; display: flex; align-items: center; flex-shrink: 0; padding-top: calc(env(safe-area-inset-top) + 10px); }
        #chat-header .contact-info { display: flex; align-items: center; gap: 0px; flex-grow: 1; overflow: hidden; }
        #current-chat-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1em; font-weight: 600; }
        #call-button { color: var(--primary-color); margin-left: auto; background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; transition: opacity 0.2s ease; }
        #call-button:hover { opacity: 0.7; }
        #call-button i { width: 22px; height: 22px; }

        #message-area { flex-grow: 1; padding: var(--element-spacing) var(--content-padding); overflow-y: auto; display: flex; flex-direction: column; gap: var(--element-spacing); -webkit-overflow-scrolling: touch; padding-bottom: var(--element-spacing); }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 0.95em; line-height: 1.45; position: relative; opacity: 1; transition: opacity 0.4s ease-out, transform 0.3s ease-out; word-wrap: break-word; box-shadow: none; }
        .message-bubble p { margin-bottom: 3px; }
        .message-timestamp { font-size: 0.7em; color: var(--text-tertiary); display: block; text-align: right; margin-top: 5px; }
        .message-bubble.outgoing .message-timestamp { color: rgba(255,255,255,0.7); }
        .message-bubble img { max-width: 100%; border-radius: var(--border-radius); margin-top: 8px; display: block; cursor: pointer; }
        .message-bubble.outgoing { background-color: var(--primary-color); color: var(--text-on-primary-bg); align-self: flex-end; }
        .message-bubble.incoming { background-color: var(--secondary-content-background); color: var(--text-primary); align-self: flex-start; }
        .message-bubble.disappearing { opacity: 0; transform: translateY(-15px) scale(0.9); }
        .encryption-status { font-size: 0.75em; color: var(--text-secondary); text-align: center; padding: 8px 15px; background-color: transparent; border-top: 1px solid var(--hairline-color); border-bottom: 1px solid var(--hairline-color); margin: 0; flex-shrink: 0; }

        #message-input-area { display: flex; align-items: center; padding: 8px var(--content-padding); padding-bottom: calc(env(safe-area-inset-bottom) + 8px); border-top: 1px solid var(--hairline-color); background-color: var(--content-background); flex-shrink: 0; gap: 10px; }
        #message-input-area input[type="text"] { flex-grow: 1; padding: 10px 16px; border: 1px solid var(--secondary-content-background); border-radius: 20px; outline: none; font-size: 1em; background-color: var(--secondary-content-background); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        #message-input-area input[type="text"]:focus { border-color: transparent; box-shadow: 0 0 0 2px var(--focus-ring-color); background-color: var(--secondary-content-background); }
        #message-input-area button { background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s ease, transform 0.1s ease-out; }
        #message-input-area button:hover { background-color: var(--hover-bg-subtle); }
        #message-input-area button:active { transform: scale(0.9); }
        #message-input-area button i { width: 24px; height: 24px; }

        /* Feed View (Redesigned) */
        #feed-view { display: flex; justify-content: center; overflow-y: auto; background-color: var(--app-background); padding: 0; padding-top: env(safe-area-inset-top); padding-bottom: calc(env(safe-area-inset-bottom) + var(--content-padding)); }
        #feed-content-wrapper { width: 100%; max-width: 620px; display: flex; flex-direction: column; align-items: stretch; padding: calc(var(--content-padding) / 2) var(--content-padding) 0; gap: calc(var(--element-spacing) * 2); }
        #create-post-section { padding: var(--content-padding); background-color: var(--content-background); border-radius: var(--border-radius); box-shadow: none; flex-shrink: 0; border: 1px solid var(--hairline-color); margin-bottom: var(--element-spacing); }
        #create-post-section h3 { font-size: 1.05em; font-weight: 600; margin-bottom: 15px; }
        #create-post-section input[type="file"], #create-post-section textarea { display: block; width: 100%; margin-bottom: 12px; padding: 10px; border: 1px solid var(--hairline-color); border-radius: var(--border-radius); font-size: 0.95em; background-color: var(--secondary-content-background); }
        #create-post-section textarea { resize: vertical; min-height: 70px; }
        #submit-post-button { padding: 10px 18px; background-color: var(--secondary-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 500; width: 100%; transition: background-color 0.2s ease; font-size: 0.95em; }
        #submit-post-button:hover { background-color: #2aa14a; }
        #feed-container { display: flex; flex-direction: column; gap: calc(var(--element-spacing) * 2.5); padding: 0; width: 100%; }
        .feed-post { background-color: transparent; border-radius: 0; box-shadow: none; overflow: visible; border: none; padding-bottom: calc(var(--element-spacing) * 2); border-bottom: 1px solid var(--hairline-color); }
        .feed-post:last-child { border-bottom: none; padding-bottom: 0; }
        .post-header { display: flex; align-items: center; padding: 0; margin-bottom: calc(var(--element-spacing) * 0.75); }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--secondary-content-background); margin-right: var(--element-spacing); object-fit: cover; overflow: hidden; flex-shrink: 0; }
        .post-user-info { display: flex; flex-direction: column; flex-grow: 1; }
        .post-username { font-weight: 500; font-size: 0.95em; line-height: 1.3; }
        .post-timestamp { font-size: 0.75em; color: var(--text-tertiary); padding: 0; text-transform: none; letter-spacing: 0; margin-top: 1px; line-height: 1.2; }
        .post-caption-container { padding: 0; font-size: 0.95em; line-height: 1.55; margin-bottom: var(--element-spacing); color: var(--text-primary); padding-left: 2px; }
        .post-caption-container .username { display: none; }
        .post-image { width: 100%; max-height: 75vh; object-fit: cover; display: block; background-color: var(--secondary-content-background); border-radius: var(--border-radius); margin-bottom: calc(var(--element-spacing) * 1.25); border: none; }
        .post-actions { padding: 0; display: flex; align-items: center; gap: 18px; }
        .action-button { background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary); display: flex; align-items: center; transition: color 0.2s ease, background-color 0.2s ease; border-radius: 50%; }
        .action-button:hover { color: var(--text-primary); background-color: var(--hover-bg-subtle); }
        .action-button i { width: 22px; height: 22px; }
        .like-button.liked { color: var(--destructive-color); }
        .like-button.liked i { fill: var(--destructive-color); }
        .like-button.liked:hover { background-color: rgba(255, 59, 48, 0.08); }
        .post-likes { font-size: 0.88em; font-weight: 500; padding: 8px 0 0; color: var(--text-secondary); }

        /* Settings View */
        #settings-view { background-color: var(--app-background); padding: var(--content-padding); padding-top: calc(env(safe-area-inset-top) + var(--content-padding)); padding-bottom: calc(env(safe-area-inset-bottom) + var(--content-padding)); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        #settings-view > div { background-color: var(--content-background); padding: var(--content-padding); border-radius: var(--border-radius-large); box-shadow: var(--shadow-subtle); margin-bottom: var(--element-spacing); border: 1px solid var(--hairline-color); }
        #settings-view h2 { font-size: 1.5em; font-weight: 600; margin-bottom: var(--content-padding); color: var(--text-primary); padding: 0; }
        #settings-view h4 { font-size: 1.05em; margin-top: 0; margin-bottom: 10px; font-weight: 600; }
        #settings-view p { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5; }
        #settings-view label { display: block; margin-bottom: 6px; font-size: 0.85em; font-weight: 500; color: var(--text-secondary); }
        #settings-view input[type="password"], #settings-view input[type="text"] { width: 100%; max-width: 380px; padding: 10px; margin-bottom: 12px; border: 1px solid var(--hairline-color); border-radius: var(--border-radius); font-size: 1em; background-color: var(--secondary-content-background); }
        #settings-view input[type="password"]:focus, #settings-view input[type="text"]:focus { box-shadow: 0 0 0 2px var(--focus-ring-color); border-color: var(--primary-color); background-color: var(--content-background); }
        #save-encryption-key-btn { background-color: var(--primary-color) !important; color: white !important; padding: 10px 16px !important; border: none !important; border-radius: var(--border-radius) !important; cursor: pointer !important; font-size: 0.95em !important; font-weight: 500; transition: background-color 0.2s ease; }
        #save-encryption-key-btn:hover { background-color: #0056b3 !important; }
        #key-status-message { font-size:0.85em; margin-top:8px; color: var(--text-secondary); }

        /* Games View */
        #games-view { display: flex; justify-content: center; overflow-y: auto; background-color: var(--app-background); padding: var(--content-padding); padding-top: calc(env(safe-area-inset-top) + var(--content-padding)); padding-bottom: calc(env(safe-area-inset-bottom) + var(--content-padding)); }
        #games-view-content { width: 100%; max-width: 900px; height: auto; padding: 0; display: flex; flex-direction: column; align-items: center;}
        #games-view-content h2 { font-size: 1.5em; margin-bottom: 8px; font-weight: 600; }
        #games-view-content > p { margin-bottom: 15px; font-size: 0.9em; color: var(--text-secondary); text-align: center; max-width: 600px; }
        #close-game-button { margin-bottom: 12px; padding: 9px 18px; background-color: var(--primary-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease; }
        #close-game-button:hover { background-color: #0056b3; }
        #game-list-container { display: flex; flex-wrap: wrap; justify-content: center; gap: var(--element-spacing); width: 100%; padding-bottom: 15px; }
        .game-thumbnail { width: 160px; padding: 0; background-color: var(--content-background); border: 1px solid var(--hairline-color); border-radius: var(--border-radius); cursor: pointer; text-align: center; transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; flex-direction: column; align-items: stretch; box-shadow: var(--shadow-subtle); overflow: hidden; }
        .game-thumbnail:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); }
        .game-thumbnail img { width: 100%; height: 100px; object-fit: cover; border-radius: 0; margin-bottom: 0; background-color: var(--secondary-content-background); border-bottom: 1px solid var(--hairline-color); }
        .game-thumbnail p { font-size: 0.9em; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; padding: 10px; }
        #game-iframe-container { width: 100%; flex-grow: 1; min-height: 300px; max-width: 100%; max-height: calc(100vh - 200px); border: 1px solid var(--hairline-color); margin: 0 auto; background-color: #000; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-medium); }
        #game-iframe { width: 100%; height: 100%; border: none; }

        /* 3D Decorator Specific Styles */
        #decorator-view { position: relative; width: 100%; height: 100%; overflow: hidden; padding: 0; background-color: #e0e0e0; }
        #scene-canvas { display: block; width: 100%; height: 100%; }
        #decorator-ui { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        #item-catalog { position: absolute; bottom: calc(env(safe-area-inset-bottom) + 10px); left: 10px; right: 10px; max-width: calc(100% - 20px); background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: var(--border-radius); padding: 8px; box-shadow: var(--shadow-medium); display: flex; gap: 8px; overflow-x: auto; pointer-events: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        #item-catalog::-webkit-scrollbar { display: none; }
        .catalog-item { flex-shrink: 0; width: 65px; padding: 5px; border: 2px solid transparent; border-radius: var(--border-radius); cursor: pointer; text-align: center; background: var(--secondary-content-background); transition: border-color 0.2s ease, background-color 0.2s ease; }
        .catalog-item.selected { border-color: var(--primary-color); background-color: var(--primary-active-bg); }
        .catalog-item img { width: 100%; height: 50px; object-fit: contain; margin-bottom: 4px; pointer-events: none; }
        .catalog-item span { font-size: 0.7em; color: var(--text-secondary); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #mode-controls { position: absolute; top: calc(env(safe-area-inset-top) + 10px); right: 10px; display: flex; gap: 8px; pointer-events: auto; }
        #mode-controls button { padding: 8px 10px; font-size: 0.85em; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--hairline-color); border-radius: var(--border-radius); box-shadow: var(--shadow-subtle); cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
        #mode-controls button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #mode-controls button:hover:not(.active) { background-color: rgba(230, 230, 230, 0.9); }
        #loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.7); color: white; padding: 15px 25px; border-radius: var(--border-radius); display: none; z-index: 100; pointer-events: none; }
        #delete-item-btn { background-color: var(--destructive-color) !important; color: white !important; border-color: var(--destructive-color) !important; }
        #delete-item-btn:hover { background-color: #D93025 !important; }

        /* Video Call Overlay */
        #video-call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); z-index: 900; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; color: white; }
        #video-call-overlay.active { display: flex; }
        #video-status { font-size: 1em; margin-bottom: 15px; }
        #video-container { width: 95%; max-width: 700px; height: 75%; max-height: 550px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #111; border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #remote-video { width: 100%; height: 100%; object-fit: contain; }
        #local-video { position: absolute; width: clamp(80px, 20%, 150px); aspect-ratio: 9/16; object-fit: cover; border: 2px solid rgba(255,255,255,0.3); border-radius: var(--border-radius); bottom: 10px; right: 10px; z-index: 901; background-color: #000; }
        #video-controls { display: flex; gap: 20px; margin-top: 25px; }
        #video-controls button { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: white; width: 55px; height: 55px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        #video-controls button:hover { background-color: rgba(255,255,255,0.2); }
        #video-controls button i { width: 24px; height: 24px; }
        #end-call-btn { background-color: var(--destructive-color); }
        #end-call-btn:hover { background-color: #D93025; }

        .hidden { display: none !important; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) { /* Tablet */
            #contact-list-container { min-width: 220px; }
            #contact-list-container.collapsed { width: 0px !important; min-width: 0px !important; }
            #feed-content-wrapper { max-width: 95%; }
            .game-thumbnail { width: calc(33.33% - 10px); }
        }

        @media (max-width: 480px) { /* Mobile phones */
            #navigation { padding: 5px; padding-bottom: calc(5px + env(safe-area-inset-bottom)); }
            .nav-tab span {display: none;} .nav-tab i {margin-bottom: 0;} .nav-tab { padding: 8px 0; gap: 0; }

            #toggle-sidebar-btn { margin-right: 4px; padding: 6px; } #toggle-sidebar-btn i { width: 18px; height: 18px; }

            #contact-list-container { width: 75px; min-width: 75px; background-color: var(--content-background); padding-top: env(safe-area-inset-top); }
            #contact-list-container.collapsed { width: 0px !important; min-width: 0px !important; }
            #contact-list-container.collapsed #search-contacts-wrapper { display: none; }
            #contact-list-container #search-contacts-wrapper { padding: 8px 5px; }
            #contact-list-container #search-contacts-input { font-size: 0.85em; padding: 6px 8px 6px 25px; }
            #contact-list-container #search-contacts-input::placeholder { color: transparent; opacity: 0; }
            #contact-list-container #search-contacts-wrapper .search-icon { left: 10px; width: 14px; height: 14px; }
            #contact-list-container h3 { display: none; }
            #contacts { padding-top: 5px; }
            #contacts li { justify-content: center; padding: 10px 0; gap: 0; margin-right: 0; border-radius: 0; border-left-width: 3px; border-bottom: none; }
            #contacts li:first-child { border-top: 1px solid var(--hairline-color); }
            #contacts li span:not(.contact-avatar) {display: none;}
            #contacts .contact-avatar { width: 40px; height: 40px; }
            .contact-avatar-text { font-size: 1.2em; }

            #chat-header { padding: 8px 12px; padding-top: calc(env(safe-area-inset-top) + 8px); }
            #chat-header .contact-avatar-header { width: 36px; height: 36px; margin-right: 8px;}
            #current-chat-name { font-size: 1em; font-weight: 500; }
            #call-button { padding: 6px; } #call-button i { width: 20px; height: 20px; }

            #message-area { padding: 10px; gap: 8px; padding-bottom: 10px; }
            .message-bubble { max-width: 80%; padding: 8px 12px; font-size: 0.95em; border-radius: 16px; }

            #message-input-area { padding: 8px 12px; gap: 8px; padding-bottom: calc(env(safe-area-inset-bottom) + 8px); }
            #message-input-area input[type="text"] { padding: 9px 14px; font-size: 1em; }
            #message-input-area button { padding: 7px; } #message-input-area button i { width: 22px; height: 22px; }

            #feed-view { padding: 0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
            #feed-content-wrapper { max-width: 100%; gap: 0; padding: 0; }
            #create-post-section { border-radius: 0; box-shadow: none; margin: 0 0 var(--element-spacing); padding: var(--content-padding); border: none; border-bottom: 1px solid var(--hairline-color); }
            #feed-container { padding: 0; gap: 0px; }
            .feed-post { border-radius: 0; box-shadow: none; border:none; border-bottom: 8px solid var(--app-background); margin-bottom: 0; padding: var(--content-padding); padding-bottom: var(--content-padding); }
            .feed-post:last-child { border-bottom: none; padding-bottom: var(--content-padding);}
            .post-header { margin-bottom: 10px; }
            .post-avatar { width: 36px; height: 36px; margin-right: 10px; }
            .post-username { font-size: 0.92em; }
            .post-timestamp { font-size: 0.75em; }
            .post-caption-container { font-size: 0.92em; line-height: 1.5; padding-left: 0; margin-bottom: 10px; }
            .post-image { margin-bottom: 12px; border-radius: var(--border-radius); }
            .post-actions { gap: 16px; }
            .action-button i { width: 20px; height: 20px; }
            .post-likes { font-size: 0.85em; padding-top: 6px; }

            #games-view { padding: 10px; padding-top: env(safe-area-inset-top); padding-bottom: calc(env(safe-area-inset-bottom) + 10px); }
            #games-view-content { max-width: 100%; }
            .game-thumbnail { width: calc(50% - 8px); }

            #settings-view { padding: 0; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
            #settings-view > div { border-radius: 0; box-shadow: none; margin-bottom: 8px; border: none; border-bottom: 1px solid var(--hairline-color); padding: var(--content-padding); }
            #settings-view h2 { padding: var(--content-padding) var(--content-padding) 10px; font-size: 1.4em; margin-bottom: 0; }

            #decorator-view { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
            #item-catalog { bottom: calc(env(safe-area-inset-bottom) + 5px); left: 5px; right: 5px; max-width: calc(100% - 10px); padding: 5px;}
            .catalog-item { width: 60px; }
            #mode-controls { top: calc(env(safe-area-inset-top) + 5px); right: 5px; }
        }
    </style>

</head>
<body>
    <div id="app-container">
        <!-- View Wrapper -->
        <div id="view-wrapper">
            <div id="chat-view" class="view active-view">
                <div id="contact-list-container">
                    <div id="search-contacts-wrapper">
                        <i data-feather="search" class="search-icon"></i>
                        <input type="search" id="search-contacts-input" placeholder="Search">
                    </div>
                    <ul id="contacts" class="scrollable-content"></ul>
                </div>
                <div id="chat-window">
                    <div id="chat-header">
                        <button id="toggle-sidebar-btn" title="Toggle Contacts"><i data-feather="arrow-left-circle"></i></button>
                        <div class="contact-info">
                            <div id="current-chat-avatar-header" class="contact-avatar-header"></div>
                            <span id="current-chat-name">Select a Chat</span>
                        </div>
                        <button id="call-button" class="hidden" title="Start Video Call"><i data-feather="video"></i></button>
                    </div>
                    <div class="encryption-status hidden" id="chat-encryption-status"></div>
                    <div id="message-area" class="scrollable-content"></div>
                    <div id="message-input-area"><input type="file" id="image-upload-chat" accept="image/*" style="display: none;"><button id="attach-image-chat-btn" title="Attach Image"><i data-feather="paperclip"></i></button><input type="text" id="message-text" placeholder="Message..."><button id="send-button" title="Send Message"><i data-feather="send"></i></button></div>
                </div>
            </div>

             <div id="feed-view" class="view scrollable-content">
                <div id="feed-content-wrapper">
                    <div id="create-post-section"><h3>Create Post</h3><input type="file" id="image-upload-feed" accept="image/*" title="Select image to upload"><textarea id="post-caption" placeholder="Write a caption..."></textarea><button id="submit-post-button">Post</button></div>
                    <div id="feed-container"></div>
                </div>
            </div>

            <div id="games-view" class="view scrollable-content">
                 <div id="games-view-content">
                    <h2>HTML5 Games</h2>
                    <p>Select a game to play! Some games may not load due to embedding restrictions.</p>
                    <button id="close-game-button" style="display: none;">Close Game</button>
                    <div id="game-list-container"></div>
                    <div id="game-iframe-container" style="display: none;">
                        <iframe id="game-iframe" allowfullscreen></iframe>
                    </div>
                 </div>
            </div>

             <div id="settings-view" class="view scrollable-content">
                 <h2>Settings</h2>
                 <div>
                    <h4>Chat Encryption (Demo)</h4>
                    <p>Enter a shared secret key for client-side message encryption. This key is stored locally and not shared automatically.</p>
                    <label for="encryption-key-input">Encryption Key:</label>
                    <input type="password" id="encryption-key-input" placeholder="Enter shared secret key">
                    <button id="save-encryption-key-btn">Set/Update Key</button>
                    <p id="key-status-message"></p>
                 </div>
                 <div>
                    <h4>Profile</h4>
                    <p>Basic profile information.</p>
                    <label for="username-input">Username:</label>
                    <input type="text" id="username-input" placeholder="Your Username">
                 </div>
            </div>

             <!-- 3D Decorator View -->
            <div id="decorator-view" class="view">
                <canvas id="scene-canvas"></canvas>
                <div id="decorator-ui">
                    <div id="mode-controls">
                        <button id="view-mode-btn" class="active">View</button>
                        <button id="edit-mode-btn">Edit</button>
                        <button id="delete-item-btn" style="display: none;">Delete</button>
                    </div>
                    <div id="item-catalog">
                        <!-- Catalog items added by JS -->
                    </div>
                </div>
                <div id="loading-indicator">Loading...</div>
            </div>

        </div> <!-- End #view-wrapper -->


        <div id="video-call-overlay">
             <div id="video-status">Connecting (Loopback Demo)...</div><div id="video-container"><video id="remote-video" autoplay playsinline></video><video id="local-video" autoplay playsinline muted></video></div>
             <div id="video-controls"><button id="mic-toggle-btn" title="Toggle Mic"><i data-feather="mic"></i></button><button id="video-toggle-btn" title="Toggle Video"><i data-feather="video"></i></button><button id="end-call-btn" title="End Call"><i data-feather="phone-off"></i></button></div>
        </div>

        <!-- Navigation Bar -->
        <nav id="navigation">
            <button class="nav-tab active" data-view="chat" title="Chat"><i data-feather="message-square"></i> <span>Chat</span></button>
            <button class="nav-tab" data-view="feed" title="Feed"><i data-feather="layout"></i> <span>Feed</span></button>
            <button class="nav-tab" data-view="games" title="Games"><i data-feather="cpu"></i> <span>Games</span></button>
            <button class="nav-tab" data-view="decorator" title="Decorate"><i data-feather="home"></i> <span>Decorate</span></button>
            <button class="nav-tab" data-view="settings" title="Settings"><i data-feather="settings"></i> <span>Settings</span></button>
        </nav>
    </div>

    <!-- Embedded JavaScript -->
    <script type="module"> // Using type="module"
        // --- Three.js Imports ---
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';

        document.addEventListener('DOMContentLoaded', () => {
            function safeFeatherReplace() { try { feather.replace(); } catch (e) { console.error("Feather icons could not be initialized:", e); }}
            safeFeatherReplace();

            // --- Global App State ---
            let currentView = 'chat';
            let encryptionKey = localStorage.getItem('chatEncryptionKey') || null;
            const masterContacts = [
                { id: 1, name: 'Alice Wonderland', avatar: 'https://i.pravatar.cc/80?u=alice', messages: [] },
                { id: 2, name: 'Bob The Builder', avatar: 'https://i.pravatar.cc/80?u=bob', messages: [] },
                { id: 3, name: 'Echo Bot', avatar: 'https://i.pravatar.cc/80?u=echobot', messages: [
                    { id: Date.now(), text: "Hi there! I'm Echo Bot. I can repeat what you say.", type: 'incoming', timestamp: Date.now(), isEncrypted: false }
                ]},
                { id: 4, name: 'Charlie Chaplin', avatar: 'https://i.pravatar.cc/80?u=charlie', messages: [] },
                { id: 5, name: 'Diana Prince', avatar: 'https://i.pravatar.cc/80?u=diana', messages: [] },
            ];
            let activeChatContactId = null;
            let feedPosts = [
                { id: Date.now() + 1, user: { name: 'AdventureSeeker', avatar: 'https://i.pravatar.cc/80?u=adv' }, image: 'https://picsum.photos/seed/travelspot/600/500', caption: 'Exploring the hidden gems! This is a longer caption to test how text wrapping and layout behaves on smaller screens and with more content than usual. The views here are breathtaking!', likes: 187, likedByUser: false, timestamp: Date.now() - (86400000 * 1.5)},
                { id: Date.now() + 2, user: { name: 'CulinaryMaster', avatar: 'https://i.pravatar.cc/80?u=chef' }, image: 'https://picsum.photos/seed/foodieplate/600/450', caption: 'Perfectly seared scallops with a lemon butter sauce. Absolutely divine!', likes: 305, likedByUser: true, timestamp: Date.now() - (86400000 * 0.75)}
            ];
            const newGamesData = [ // --- IMPORTANT: Paste your large newGamesData array back here ---
               { "title": "Monster Truck Race Arena", "embed": "https://cloud.onlinegames.io/games/2021/3/monster-truck-race-arena/index-og.html", "image": "https://www.onlinegames.io/media/posts/996/responsive/Monster-Truck-Race-Arena-xs.jpg" },
               { "title": "Kick the Alien", "embed": "https://cloud.onlinegames.io/games/2021/4/kick-the-alien/index-og.html", "image": "https://www.onlinegames.io/media/posts/997/responsive/Kick-the-Alien-xs.jpg" },
               // ... Add the rest of your game data
            ];
            // --- End of games data ---
            let games = newGamesData.map((game, index) => ({ id: `game_${index}`, name: game.title, url: game.embed, thumbnailUrl: game.image }));

            const EPHEMERAL_MESSAGE_DURATION = 30000;
            let localStream, peerConnection, isVideoCallActive = false;
            const iceServers = { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] };

            // --- DOM Element Selections ---
            const viewWrapper = document.getElementById('view-wrapper');
            const navTabs = document.querySelectorAll('.nav-tab');
            const views = viewWrapper.querySelectorAll('.view');
            const contactListEl=document.getElementById('contacts');
            const contactListContainerEl = document.getElementById('contact-list-container');
            const searchContactsInput = document.getElementById('search-contacts-input');
            const currentChatNameEl=document.getElementById('current-chat-name'),currentChatAvatarHeaderEl=document.getElementById('current-chat-avatar-header'),messageAreaEl=document.getElementById('message-area'),messageInputEl=document.getElementById('message-text'),sendButton=document.getElementById('send-button'),attachImageChatBtn=document.getElementById('attach-image-chat-btn'),imageUploadChatInput=document.getElementById('image-upload-chat'),chatEncryptionStatusEl=document.getElementById('chat-encryption-status'),callButton=document.getElementById('call-button'),feedContainerEl=document.getElementById('feed-container'),createPostImageInput=document.getElementById('image-upload-feed'),createPostCaptionInput=document.getElementById('post-caption'),submitPostButton=document.getElementById('submit-post-button'),encryptionKeyInput=document.getElementById('encryption-key-input'),saveEncryptionKeyBtn=document.getElementById('save-encryption-key-btn'),keyStatusMessageEl=document.getElementById('key-status-message'),videoCallOverlay=document.getElementById('video-call-overlay'),localVideoEl=document.getElementById('local-video'),remoteVideoEl=document.getElementById('remote-video'),micToggleBtn=document.getElementById('mic-toggle-btn'),videoToggleBtn=document.getElementById('video-toggle-btn'),endCallBtn=document.getElementById('end-call-btn'),videoStatusEl=document.getElementById('video-status');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            const gamesViewEl = document.getElementById('games-view');
            const gamesViewContentEl = document.getElementById('games-view-content');
            const gameListContainerEl = document.getElementById('game-list-container');
            const gameIframeContainerEl = document.getElementById('game-iframe-container');
            const gameIframeEl = document.getElementById('game-iframe');
            const closeGameButton = document.getElementById('close-game-button');
            const gamesViewHeading = gamesViewContentEl ? gamesViewContentEl.querySelector('h2') : null;
            const gamesViewIntroP = gamesViewContentEl ? gamesViewContentEl.querySelector('p') : null;

            // --- 3D Decorator Elements ---
            const decoratorCanvas = document.getElementById('scene-canvas');
            const decoratorCatalogContainer = document.getElementById('item-catalog');
            const decoratorLoadingIndicator = document.getElementById('loading-indicator');
            const decoratorViewModeBtn = document.getElementById('view-mode-btn');
            const decoratorEditModeBtn = document.getElementById('edit-mode-btn');
            const decoratorDeleteBtn = document.getElementById('delete-item-btn');

             // --- Helper Functions ---
             function encryptMessage(text, key) { if (!key || !text) return text; try { return CryptoJS.AES.encrypt(text, key).toString(); } catch (e) { console.error("Encryption failed:", e); return `Error encrypting: ${text.substring(0,10)}...`; }}
             function decryptMessage(ciphertext, key) { if (!key || !ciphertext) return ciphertext; try { const bytes = CryptoJS.AES.decrypt(ciphertext, key); const originalText = bytes.toString(CryptoJS.enc.Utf8); return originalText || "[Unable to decrypt - possibly wrong key]"; } catch (e) { console.error("Decryption failed:", e); return `[Decryption Error] ${ciphertext.substring(0,10)}...`; }}
             function updateEncryptionKeyStatus() { if(!encryptionKeyInput || !keyStatusMessageEl) return; if (encryptionKey) { encryptionKeyInput.value = encryptionKey; keyStatusMessageEl.textContent = "Client-side encryption key is set."; keyStatusMessageEl.style.color = "var(--secondary-color)"; } else { encryptionKeyInput.value = ''; keyStatusMessageEl.textContent = "Client-side encryption key is NOT set. Applicable messages will not be encrypted."; keyStatusMessageEl.style.color = "var(--destructive-color)"; } if (activeChatContactId) { const contact = masterContacts.find(c => c.id === activeChatContactId); updateChatEncryptionBanner(contact); }}
             function updateChatEncryptionBanner(contact) { if(!chatEncryptionStatusEl) return; if (contact && contact.name !== 'Echo Bot') { chatEncryptionStatusEl.classList.toggle('hidden', !encryptionKey); chatEncryptionStatusEl.textContent = encryptionKey ? `🔒 Messages client-side encrypted.` : `⚠️ No client-side key. Messages not encrypted.`; } else { chatEncryptionStatusEl.classList.add('hidden'); }}
             function formatTimestamp(timestamp) { return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });}
             function formatPostTimestamp(timestamp) { const now = new Date(); const postDate = new Date(timestamp); const diffSeconds = Math.round((now - postDate) / 1000); if (diffSeconds < 60) return "Just now"; const diffMinutes = Math.round(diffSeconds / 60); if (diffMinutes < 60) return `${diffMinutes}m ago`; const diffHours = Math.round(diffMinutes / 60); if (diffHours < 24) return `${diffHours}h ago`; const diffDays = Math.round(diffHours / 24); if (diffDays < 7) return `${diffDays}d ago`; return postDate.toLocaleDateString(); }

            // --- UI & View Functions ---
            function switchView(viewName) {
                const oldView = currentView; currentView = viewName;
                views.forEach(view => view.classList.remove('active-view'));
                navTabs.forEach(tab => tab.classList.remove('active'));
                const targetViewEl = viewWrapper.querySelector(`#${viewName}-view`);
                if (targetViewEl) targetViewEl.classList.add('active-view');
                else console.error(`Target view element "${viewName}-view" NOT FOUND!`);
                const targetNavTabEl = document.querySelector(`.nav-tab[data-view="${viewName}"]`);
                if (targetNavTabEl) targetNavTabEl.classList.add('active');
                else console.error(`Target nav tab for view "${viewName}" NOT FOUND!`);

                if (oldView === 'games' && viewName !== 'games' && gameIframeContainerEl && (gameIframeContainerEl.style.display === 'block' || gameIframeContainerEl.style.display === 'flex')) closeGame();
                if (viewName === 'feed') renderFeed();
                if (viewName === 'chat') {
                    renderContacts(masterContacts);
                    if (toggleSidebarBtn && contactListContainerEl) {
                         const isCollapsed = contactListContainerEl.classList.contains('collapsed');
                         toggleSidebarBtn.innerHTML = isCollapsed ? feather.icons['arrow-right-circle'].toSvg() : feather.icons['arrow-left-circle'].toSvg();
                    }
                }
                if (viewName === 'settings') updateEncryptionKeyStatus();
                if (viewName === 'games') renderGamesList();
                if (viewName === 'decorator' && !decoratorSceneInitialized) {
                     try {
                        init3DDecorator();
                     } catch (error) {
                        console.error("Failed to initialize 3D Decorator:", error);
                        if(decoratorLoadingIndicator) decoratorLoadingIndicator.textContent = "Error loading 3D view.";
                        if(decoratorLoadingIndicator) decoratorLoadingIndicator.style.display = 'block';
                     }
                }
                 safeFeatherReplace();
            }

            function renderContacts(contactsToDisplay = masterContacts) {
                 if (!contactListEl) return;
                contactListEl.innerHTML = '';
                if (contactsToDisplay.length === 0 && searchContactsInput && searchContactsInput.value.trim() !== '') {
                    const li = document.createElement('li'); li.classList.add('no-contacts-found'); li.textContent = 'No contacts found.'; contactListEl.appendChild(li); return;
                }
                contactsToDisplay.forEach(c => {
                    const li = document.createElement('li');
                    const avatarContent = c.avatar && c.avatar.startsWith('http') ? `<img src="${c.avatar}" alt="${c.name}" class="contact-avatar-img">` : `<span class="contact-avatar-text">${c.avatar || c.name.charAt(0)}</span>`;
                    li.innerHTML = `<div class="contact-avatar">${avatarContent}</div><span>${c.name}</span>`;
                    li.dataset.contactId = c.id;
                    if (c.id === activeChatContactId) li.classList.add('active-contact');
                    li.addEventListener('click', () => selectChat(c.id));
                    contactListEl.appendChild(li);
                });
            }

            function selectChat(contactId) {
                activeChatContactId = contactId;
                const c = masterContacts.find(ct => ct.id === contactId);
                if(!currentChatNameEl || !currentChatAvatarHeaderEl || !callButton) return;
                currentChatNameEl.textContent = c ? c.name : 'Select a Chat';
                if (c && c.avatar) { currentChatAvatarHeaderEl.innerHTML = c.avatar.startsWith('http') ? `<img src="${c.avatar}" alt="${c.name}" class="contact-avatar-img">` : `<span class="contact-avatar-text">${c.avatar || c.name.charAt(0)}</span>`; }
                else { currentChatAvatarHeaderEl.innerHTML = c ? `<span class="contact-avatar-text">${c.name.charAt(0)}</span>` : ''; }
                callButton.classList.toggle('hidden', !c || c.name === 'Echo Bot');
                updateChatEncryptionBanner(c);
                if (searchContactsInput) searchContactsInput.value = '';
                renderContacts(masterContacts);
                renderMessages();
            }

            function renderMessages() { if (!messageAreaEl) return; messageAreaEl.innerHTML=''; if(!activeChatContactId)return; const contact = masterContacts.find(c => c.id === activeChatContactId); if(contact && contact.messages){contact.messages.forEach(msg=>{let dMsg={...msg}; if(msg.isEncrypted){if(encryptionKey)dMsg.text=decryptMessage(msg.text,encryptionKey); else dMsg.text=`🔒 [Encrypted] (${msg.text.length} chars)`;} displayMessage(dMsg);});} requestAnimationFrame(() => { if(messageAreaEl) messageAreaEl.scrollTop=messageAreaEl.scrollHeight; });}
            function displayMessage(message) { if (!messageAreaEl) return; const b=document.createElement('div');b.classList.add('message-bubble',message.type);b.id=`msg-${message.id}`; const t=document.createElement('p');t.textContent=message.text;b.appendChild(t); if(message.image){const i=document.createElement('img');i.src=message.image;b.appendChild(i);} const time=document.createElement('span');time.classList.add('message-timestamp');time.textContent=formatTimestamp(message.timestamp);b.appendChild(time);messageAreaEl.appendChild(b); requestAnimationFrame(() => { if(messageAreaEl) messageAreaEl.scrollTop=messageAreaEl.scrollHeight; }); if(message.type==='outgoing'||(message.type==='incoming'&&masterContacts.find(c=>c.id===activeChatContactId)?.name!=='Echo Bot')){setTimeout(()=>{b.classList.add('disappearing');setTimeout(()=>b.remove(),500);},EPHEMERAL_MESSAGE_DURATION);}}
            function sendMessage(text, image = null) { if(!activeChatContactId||(!text&&!image) || !messageInputEl)return;const contact = masterContacts.find(c=>c.id===activeChatContactId);if(!contact)return;let pText=text;let isEnc=false;if(contact.name!=='Echo Bot'){if(encryptionKey&&text){pText=encryptMessage(text,encryptionKey);isEnc=true;}else if(!encryptionKey&&text){isEnc=false;}}const nM={id:Date.now(),text:pText,image:image,type:'outgoing',timestamp:Date.now(),isEncrypted:isEnc}; if(!contact.messages) contact.messages = []; contact.messages.push(nM);let dMsg={...nM};if(isEnc&&text)dMsg.text=text;displayMessage(dMsg);messageInputEl.value='';if(imageUploadChatInput) imageUploadChatInput.value='';if(contact.name==="Echo Bot"){setTimeout(()=>simulateBotReply(contact.id,text||(image?"[Image Sent]":"[Empty Message]")),1000);}}
            function simulateBotReply(contactId,originalUserMessage) { let rText=`Echo: "${originalUserMessage}"`;if(originalUserMessage.toLowerCase().includes("hello")||originalUserMessage.toLowerCase().includes("hi"))rText="Echo says: Hello back to you! 👋";else if(originalUserMessage.toLowerCase().includes("how are you"))rText="Echo status: Operational and echoing! How are YOU?";else if(originalUserMessage.length>50)rText=`Echo (long message received!): "${originalUserMessage.substring(0,20)}..."`;const rM={id:Date.now()+1,text:rText,type:'incoming',timestamp:Date.now(),isEncrypted:false};const contact=masterContacts.find(ct=>ct.id===contactId);if(contact&&activeChatContactId===contactId){if(!contact.messages) contact.messages = []; contact.messages.push(rM);displayMessage(rM);}}

            function renderFeed() {
                if (!feedContainerEl) return;
                feedContainerEl.innerHTML = '';
                if (!Array.isArray(feedPosts) || feedPosts.length === 0) {
                    feedContainerEl.innerHTML = '<p style="text-align:center; padding:20px; color: var(--text-secondary-color);">No posts yet. Create one!</p>';
                    feather.replace(); return;
                }
                feedPosts.slice().reverse().forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.classList.add('feed-post');
                    postEl.innerHTML = `
                        <div class="post-header">
                            <img src="${post.user.avatar}" alt="${post.user.name}" class="post-avatar">
                            <div class="post-user-info">
                                <span class="post-username">${post.user.name}</span>
                                <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                            </div>
                        </div>
                        ${post.caption ? `<div class="post-caption-container"><span>${post.caption}</span></div>` : ''}
                        ${post.image ? `<img src="${post.image}" class="post-image">` : ''}
                        <div class="post-actions">
                            <button class="action-button like-button ${post.likedByUser ? 'liked' : ''}" data-post-id="${post.id}">
                                <i data-feather="heart"${post.likedByUser ? ` style="fill: var(--destructive-color);"` : ''}></i>
                            </button>
                            <button class="action-button"><i data-feather="message-circle"></i></button>
                            <button class="action-button"><i data-feather="send"></i></button>
                        </div>
                        ${post.likes > 0 ? `<div class="post-likes">${post.likes.toLocaleString()} like${post.likes !== 1 ? 's' : ''}</div>` : ''}
                    `;
                    feedContainerEl.appendChild(postEl);
                });
                feather.replace();
            }
            function toggleLike(postId) {const p=feedPosts.find(post=>post.id==postId);if(p){p.likedByUser=!p.likedByUser;p.likes+=p.likedByUser?1:-1;renderFeed();}}
            function createPost(imageUrl,caption){if(!imageUrl&&!caption){alert("Please select an image or write a caption.");return;}const nP={id:Date.now(),user:{name:'You (Demo)',avatar:'https://i.pravatar.cc/80?u=demoUser'},image:imageUrl,caption:caption||"",likes:0,likedByUser:false,timestamp:Date.now()};feedPosts.push(nP);renderFeed();if(createPostImageInput)createPostImageInput.value='';if(createPostCaptionInput)createPostCaptionInput.value='';}
            function renderGamesList() { if (!gameListContainerEl) return; gameListContainerEl.innerHTML = ''; games.forEach(game => { const gameEl = document.createElement('div'); gameEl.classList.add('game-thumbnail'); gameEl.dataset.gameUrl = game.url; gameEl.innerHTML = `<img src="${game.thumbnailUrl}" alt="${game.name}" onerror="this.src='https://via.placeholder.com/150/CCCCCC/FFFFFF?Text=No+Image'; this.onerror=null;"><p title="${game.name}">${game.name}</p>`; gameEl.addEventListener('click', () => loadGame(game.url, game.name)); gameListContainerEl.appendChild(gameEl); }); if(closeGameButton) closeGameButton.style.display = 'none'; if(gameIframeContainerEl) gameIframeContainerEl.style.display = 'none'; if(gameIframeEl) gameIframeEl.src = 'about:blank'; if(gameListContainerEl) gameListContainerEl.style.display = 'flex'; if(gamesViewHeading) gamesViewHeading.style.display = 'block'; if(gamesViewIntroP) gamesViewIntroP.style.display = 'block'; }
            function loadGame(gameUrl, gameName) { if(!gameIframeEl || !gameIframeContainerEl || !gameListContainerEl || !closeGameButton) return; gameIframeEl.src = gameUrl; gameIframeContainerEl.style.display = 'block'; gameListContainerEl.style.display = 'none'; closeGameButton.style.display = 'block'; if(gamesViewHeading) gamesViewHeading.style.display = 'none'; if(gamesViewIntroP) gamesViewIntroP.style.display = 'none'; }
            function closeGame() { if(!gameIframeEl || !gameIframeContainerEl || !gameListContainerEl || !closeGameButton) return; gameIframeEl.src = 'about:blank'; gameIframeContainerEl.style.display = 'none'; gameListContainerEl.style.display = 'flex'; closeGameButton.style.display = 'none'; if(gamesViewHeading) gamesViewHeading.style.display = 'block'; if(gamesViewIntroP) gamesViewIntroP.style.display = 'block'; }
            async function startVideoCall() {if(isVideoCallActive || !videoCallOverlay || !videoStatusEl || !localVideoEl || !remoteVideoEl)return;isVideoCallActive=true;videoCallOverlay.classList.add('active');videoStatusEl.textContent="Accessing camera/mic...";feather.replace();try{localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});localVideoEl.srcObject=localStream;videoStatusEl.textContent="Local media connected. Loopback setup...";peerConnection=new RTCPeerConnection(iceServers);localStream.getTracks().forEach(t=>peerConnection.addTrack(t,localStream));peerConnection.ontrack=e=>{if(e.streams&&e.streams[0]){remoteVideoEl.srcObject=e.streams[0];videoStatusEl.textContent="Video Loopback Active";}else if(!remoteVideoEl.srcObject&&e.track.kind==='video'){remoteVideoEl.srcObject=new MediaStream([e.track]);videoStatusEl.textContent="Video Loopback Active (Track)";}};peerConnection.onicecandidate=e=>{if(e.candidate)peerConnection.addIceCandidate(e.candidate).catch(err=>console.error("ICE add error",err));};const o=await peerConnection.createOffer();await peerConnection.setLocalDescription(o);await peerConnection.setRemoteDescription(o);}catch(err){console.error("Video call error:",err);videoStatusEl.textContent=`Error: ${err.message}`;}}
            function stopVideoCall() { if(!videoCallOverlay || !localVideoEl || !remoteVideoEl || !videoStatusEl) return; isVideoCallActive=false;videoCallOverlay.classList.remove('active');if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}if(peerConnection){peerConnection.close();peerConnection=null;}localVideoEl.srcObject=null;remoteVideoEl.srcObject=null;videoStatusEl.textContent="Call Ended";}
            function toggleMic() {if(!localStream || !micToggleBtn)return;const at=localStream.getAudioTracks()[0];if(at){at.enabled=!at.enabled;micToggleBtn.innerHTML=at.enabled?feather.icons['mic'].toSvg():feather.icons['mic-off'].toSvg();}}
            function toggleVideo() {if(!localStream || !videoToggleBtn || !localVideoEl)return;const vt=localStream.getVideoTracks()[0];if(vt){vt.enabled=!vt.enabled;videoToggleBtn.innerHTML=vt.enabled?feather.icons['video'].toSvg():feather.icons['video-off'].toSvg();localVideoEl.style.visibility=vt.enabled?'visible':'hidden';}}

            // --- 3D Decorator Logic ---
            let decoratorScene, decoratorCamera, decoratorRenderer, decoratorOrbitControls, decoratorTransformControls;
            let decoratorFloorPlane;
            let decoratorRaycaster, decoratorPointer;
            let decoratorSelectedCatalogItem = null;
            let decoratorSelectedPlacedObject = null;
            let decoratorCurrentEditMode = 'view';
            const decoratorPlacedItems = {};
            let decoratorUniqueItemIdCounter = 0;
            let decoratorSceneInitialized = false;
            const decoratorClock = new THREE.Clock(); // For grass animation timing
            const animatedGrassAssets = { material: null, shader: null }; // To store grass assets for animation updates


             const decoratorItemsData = [ // Using corrected online asset URLs
                 { id: 'shiba', name: 'Shiba Dog', modelUrl: 'https://rawcdn.githack.com/mrdoob/three.js/r129/examples/models/gltf/ShibaInu.glb', preview: 'https://via.placeholder.com/60x50.png?text=Dog' },
                 { id: 'duck', name: 'Duck', modelUrl: 'https://rawcdn.githack.com/mrdoob/three.js/r129/examples/models/gltf/Duck/glTF-Binary/Duck.glb', preview: 'https://via.placeholder.com/60x50.png?text=Duck' },
                 { id: 'helmet', name: 'Helmet', modelUrl: 'https://rawcdn.githack.com/mrdoob/three.js/r129/examples/models/gltf/DamagedHelmet/glTF-Binary/DamagedHelmet.glb', preview: 'https://via.placeholder.com/60x50.png?text=Helmet' },
                 { id: 'flower', name: 'Flower', modelUrl: 'https://rawcdn.githack.com/mrdoob/three.js/r129/examples/models/gltf/Flower/Flower.glb', preview: 'https://via.placeholder.com/60x50.png?text=Flower' },
             ];

            function init3DDecorator() {
                if (decoratorSceneInitialized || !decoratorCanvas) {
                    console.log("3D Decorator already initialized or canvas not found.");
                    return;
                }
                console.log("Initializing 3D Decorator...");
                try {
                    // Use imported THREE, OrbitControls, GLTFLoader, TransformControls
                    decoratorScene = new THREE.Scene();
                    decoratorScene.background = new THREE.Color(0xeeeeee);

                    decoratorCamera = new THREE.PerspectiveCamera(60, decoratorCanvas.clientWidth / decoratorCanvas.clientHeight, 0.1, 1000);
                    decoratorCamera.position.set(5, 6, 8);
                    decoratorCamera.lookAt(0, 0, 0);

                    decoratorRenderer = new THREE.WebGLRenderer({ canvas: decoratorCanvas, antialias: true });
                    decoratorRenderer.setSize(decoratorCanvas.clientWidth, decoratorCanvas.clientHeight);
                    decoratorRenderer.setPixelRatio(window.devicePixelRatio);
                    decoratorRenderer.shadowMap.enabled = true;

                    const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
                    decoratorScene.add(ambientLight);
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(8, 15, 10);
                    directionalLight.castShadow = true;
                    directionalLight.shadow.mapSize.width = 1024; directionalLight.shadow.mapSize.height = 1024; directionalLight.shadow.camera.near = 0.5; directionalLight.shadow.camera.far = 50;
                    decoratorScene.add(directionalLight);

                    decoratorOrbitControls = new OrbitControls(decoratorCamera, decoratorRenderer.domElement);
                    decoratorOrbitControls.enableDamping = true; decoratorOrbitControls.dampingFactor = 0.05; decoratorOrbitControls.screenSpacePanning = false; decoratorOrbitControls.maxPolarAngle = Math.PI / 2 - 0.05; decoratorOrbitControls.target.set(0, 0.5, 0); decoratorOrbitControls.update();

                    decoratorTransformControls = new TransformControls(decoratorCamera, decoratorRenderer.domElement);
                    decoratorTransformControls.addEventListener('dragging-changed', (event) => { decoratorOrbitControls.enabled = !event.value; if (!event.value && decoratorSelectedPlacedObject) sendObjectUpdate(decoratorSelectedPlacedObject.uuid, decoratorSelectedPlacedObject.position, decoratorSelectedPlacedObject.rotation); });
                    decoratorTransformControls.size = 0.75; decoratorScene.add(decoratorTransformControls);

                    decoratorRaycaster = new THREE.Raycaster(); decoratorPointer = new THREE.Vector2();
                    create3DRoom(); populate3DCatalog();
                    createAnimatedGrass(decoratorScene, 10); // Added grass
                    decoratorCanvas.addEventListener('pointerdown', onDecoratorPointerDown);
                    if(decoratorViewModeBtn) decoratorViewModeBtn.addEventListener('click', () => setDecoratorEditMode('view'));
                    if(decoratorEditModeBtn) decoratorEditModeBtn.addEventListener('click', () => setDecoratorEditMode('edit'));
                    if(decoratorDeleteBtn) decoratorDeleteBtn.addEventListener('click', deleteDecoratorSelectedItem);
                    animateDecorator(); decoratorSceneInitialized = true;
                    console.log("3D Decorator Initialized Successfully.");
                } catch (error) {
                    console.error("ERROR initializing 3D Decorator:", error);
                    if(decoratorLoadingIndicator) decoratorLoadingIndicator.textContent = "Error Initializing 3D";
                    if(decoratorLoadingIndicator) decoratorLoadingIndicator.style.display = 'block';
                }
            }
            function create3DRoom() { if(!decoratorScene) return; const floorGeometry = new THREE.PlaneGeometry(10, 10); const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc, side: THREE.DoubleSide }); decoratorFloorPlane = new THREE.Mesh(floorGeometry, floorMaterial); decoratorFloorPlane.rotation.x = -Math.PI / 2; decoratorFloorPlane.receiveShadow = true; decoratorFloorPlane.name = "floor"; decoratorScene.add(decoratorFloorPlane); }
            function populate3DCatalog() { if (!decoratorCatalogContainer) return; decoratorCatalogContainer.innerHTML = ''; decoratorItemsData.forEach(item => { const div = document.createElement('div'); div.className = 'catalog-item'; div.dataset.itemId = item.id; div.innerHTML = `<img src="${item.preview || 'https://via.placeholder.com/60x50/e0e0e0/909090?text=N/A'}" alt="${item.name}"><span>${item.name}</span>`; div.addEventListener('click', () => { if (decoratorCurrentEditMode !== 'edit') return; const currentSelected = decoratorCatalogContainer.querySelector('.selected'); if (currentSelected) currentSelected.classList.remove('selected'); div.classList.add('selected'); decoratorSelectedCatalogItem = item; deselectDecoratorPlacedObject(); }); decoratorCatalogContainer.appendChild(div); }); }
            function setDecoratorEditMode(mode) { if (decoratorCurrentEditMode === mode || !decoratorViewModeBtn || !decoratorEditModeBtn || !decoratorCatalogContainer || !decoratorOrbitControls) return; decoratorCurrentEditMode = mode; decoratorViewModeBtn.classList.toggle('active', mode === 'view'); decoratorEditModeBtn.classList.toggle('active', mode === 'edit'); if (mode === 'view') { deselectDecoratorPlacedObject(); decoratorOrbitControls.enabled = true; decoratorCatalogContainer.style.pointerEvents = 'none'; decoratorCatalogContainer.style.opacity = '0.7'; } else { decoratorOrbitControls.enabled = true; decoratorCatalogContainer.style.pointerEvents = 'auto'; decoratorCatalogContainer.style.opacity = '1'; } }
            function getDecoratorPointerVector(event) { if(!decoratorCanvas) return new THREE.Vector2(0,0); const touch = event.changedTouches ? event.changedTouches[0] : event; const rect = decoratorCanvas.getBoundingClientRect(); decoratorPointer.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1; decoratorPointer.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1; return decoratorPointer; }
            function onDecoratorPointerDown(event) { event.preventDefault(); if(!decoratorRaycaster || !decoratorCamera || !decoratorScene || !decoratorFloorPlane || !decoratorPlacedItems) return; const pointerVec = getDecoratorPointerVector(event); decoratorRaycaster.setFromCamera(pointerVec, decoratorCamera); if (decoratorCurrentEditMode === 'edit') { const itemMeshes = Object.values(decoratorPlacedItems).map(item => item.threeObject); const intersectsItems = decoratorRaycaster.intersectObjects(itemMeshes, true); if (intersectsItems.length > 0) { let clickedObject = intersectsItems[0].object; while (clickedObject.parent && clickedObject.parent !== decoratorScene) { if (decoratorPlacedItems[clickedObject.uuid]) break; clickedObject = clickedObject.parent; } if (decoratorPlacedItems[clickedObject.uuid]) { selectDecoratorPlacedObject(clickedObject); decoratorSelectedCatalogItem = null; const currentSelectedCatalog = decoratorCatalogContainer.querySelector('.selected'); if (currentSelectedCatalog) currentSelectedCatalog.classList.remove('selected'); return; } } if (decoratorSelectedCatalogItem) { if(!decoratorFloorPlane) return; const intersectsFloor = decoratorRaycaster.intersectObject(decoratorFloorPlane); if (intersectsFloor.length > 0) { const intersectionPoint = intersectsFloor[0].point; placeDecoratorItem(decoratorSelectedCatalogItem, intersectionPoint); const currentSelectedCatalog = decoratorCatalogContainer.querySelector('.selected'); if (currentSelectedCatalog) currentSelectedCatalog.classList.remove('selected'); decoratorSelectedCatalogItem = null; } } else { deselectDecoratorPlacedObject(); } } }
            function placeDecoratorItem(itemData, position) {
                if (!itemData || !itemData.modelUrl || !decoratorScene) return;
                showDecoratorLoading(true);

                const loader = new GLTFLoader();
                loader.load(itemData.modelUrl, gltf => {
                const model = gltf.scene;

                /* 1️⃣  SCALE FIRST so BBox uses final size  */
                let scale = 1;
                if (itemData.id === 'shiba')  scale = 0.5;
                if (itemData.id === 'duck')   scale = 0.15;
                if (itemData.id === 'helmet') scale = 0.5;
                if (itemData.id === 'flower') scale = 1.0;
                model.scale.set(scale, scale, scale);
                model.updateMatrixWorld(true); // Ensure matrix is updated for bounding box calculation

                /* 2️⃣  Compute offset after scaling          */
                const box    = new THREE.Box3().setFromObject(model);
                const offset = -box.min.y; // Calculate offset to align model's base with y=0

                /* 3️⃣  Position model at click-point         */
                model.position.copy(position); // Set initial position to click point
                model.position.y += offset;    // Adjust y based on calculated offset

                /* 4️⃣  Shadows                               */
                model.traverse(c => {
                    if (c.isMesh) { c.castShadow = c.receiveShadow = true; }
                });

                /* 5️⃣  Book-keeping                          */
                const id = `item_${decoratorUniqueItemIdCounter++}`;
                model.uuid = id; // Assign unique ID for local tracking
                decoratorScene.add(model);
                decoratorPlacedItems[id] = { threeObject:model, dataId:itemData.id };

                selectDecoratorPlacedObject(model);
                sendObjectUpdate(id, model.position, model.rotation, itemData.id, true);
                showDecoratorLoading(false);
                },
                undefined,
                err => { console.error(`GLTF load error (${itemData.name})`, err);
                        showDecoratorLoading(false);
                        alert(`Could not load "${itemData.name}". See console.`); });
            }

            function selectDecoratorPlacedObject(object) { if (decoratorSelectedPlacedObject === object || !decoratorTransformControls || !decoratorDeleteBtn || !decoratorOrbitControls) return; decoratorSelectedPlacedObject = object; decoratorTransformControls.attach(object); decoratorDeleteBtn.style.display = 'block'; decoratorOrbitControls.enabled = false; }
            function deselectDecoratorPlacedObject() { if (decoratorSelectedPlacedObject && decoratorTransformControls && decoratorDeleteBtn && decoratorOrbitControls) { decoratorTransformControls.detach(); decoratorSelectedPlacedObject = null; decoratorDeleteBtn.style.display = 'none'; decoratorOrbitControls.enabled = true; } }
            function deleteDecoratorSelectedItem() { if (decoratorSelectedPlacedObject && decoratorCurrentEditMode === 'edit' && decoratorScene) { const idToDelete = decoratorSelectedPlacedObject.uuid; deselectDecoratorPlacedObject(); const itemToRemove = decoratorPlacedItems[idToDelete]; if (itemToRemove) { decoratorScene.remove(itemToRemove.threeObject); itemToRemove.threeObject.traverse(child => { if (child.isMesh) { if(child.geometry) child.geometry.dispose(); if (child.material) { if (Array.isArray(child.material)) child.material.forEach(m => {if(m.dispose) m.dispose();}); else if(child.material.dispose) child.material.dispose();}} }); delete decoratorPlacedItems[idToDelete]; sendObjectDelete(idToDelete); console.log(`Deleted item: ${idToDelete}`); } } }
            function showDecoratorLoading(isLoading) { if (decoratorLoadingIndicator) decoratorLoadingIndicator.style.display = isLoading ? 'block' : 'none'; }
            
            function animateDecorator() {
                requestAnimationFrame(animateDecorator);
                if (currentView !== 'decorator' || !decoratorSceneInitialized || !decoratorRenderer || !decoratorCamera) {
                    return;
                }

                const deltaTime = decoratorClock.getDelta();

                if (decoratorOrbitControls) {
                    decoratorOrbitControls.update();
                }

                // Update grass animation time
                if (animatedGrassAssets.shader && animatedGrassAssets.shader.uniforms.time) {
                    animatedGrassAssets.shader.uniforms.time.value += deltaTime;
                }

                // Resize check
                if (decoratorCanvas &&
                    (decoratorCanvas.clientWidth !== decoratorRenderer.domElement.width ||
                     decoratorCanvas.clientHeight !== decoratorRenderer.domElement.height)) {
                    decoratorRenderer.setSize(decoratorCanvas.clientWidth, decoratorCanvas.clientHeight, false);
                    decoratorCamera.aspect = decoratorCanvas.clientWidth / decoratorCanvas.clientHeight;
                    decoratorCamera.updateProjectionMatrix();
                }
                decoratorRenderer.render(decoratorScene, decoratorCamera);
            }

            function sendObjectUpdate(id, position, rotation, dataId = null, isNew = false) { const updateData = { action: isNew ? 'create' : 'update', id, dataId, position: { x: position.x, y: position.y, z: position.z }, rotation: { x: rotation.x, y: rotation.y, z: rotation.z } }; console.log("SIMULATE SEND:", JSON.stringify(updateData)); }
            function sendObjectDelete(id) { const updateData = { action: 'delete', id }; console.log("SIMULATE SEND:", JSON.stringify(updateData)); }
            function handleIncomingUpdate(data) {
                 console.log("SIMULATE RECEIVE:", JSON.stringify(data));
                 if(!decoratorScene || !decoratorPlacedItems) return;
                 if (data.action === 'create' || data.action === 'update') {
                     let item = decoratorPlacedItems[data.id];
                     if (!item && data.action === 'create' && data.dataId) {
                         const itemDefinition = decoratorItemsData.find(d => d.id === data.dataId);
                         if (itemDefinition) {
                             const loader = new GLTFLoader();
                             loader.load(itemDefinition.modelUrl, (gltf) => {
                                 const model = gltf.scene;
                                 model.uuid = data.id;
                                 model.position.set(data.position.x, data.position.y, data.position.z);
                                 model.rotation.set(data.rotation.x, data.rotation.y, data.rotation.z);
                                 let scale = 1.0;
                                 if (itemDefinition.id === 'shiba') scale = 0.5;
                                 else if (itemDefinition.id === 'duck') scale = 0.15; // Consistent scale
                                 else if (itemDefinition.id === 'helmet') scale = 0.5;
                                 else if (itemDefinition.id === 'flower') scale = 1.0;
                                 model.scale.set(scale, scale, scale);
                                 model.traverse( function ( child ) { if ( child.isMesh ) { child.castShadow = true; child.receiveShadow = true; } } );
                                 decoratorScene.add(model);
                                 decoratorPlacedItems[data.id] = { threeObject: model, dataId: data.dataId };
                             }, undefined, (err) => console.error("Error loading remote create:", err));
                         }
                     } else if (item) {
                         if (decoratorSelectedPlacedObject !== item.threeObject) { // Avoid updating if currently being dragged
                              item.threeObject.position.set(data.position.x, data.position.y, data.position.z);
                              item.threeObject.rotation.set(data.rotation.x, data.rotation.y, data.rotation.z);
                         }
                     }
                 } else if (data.action === 'delete') {
                      const itemToRemove = decoratorPlacedItems[data.id];
                      if (itemToRemove) { if (decoratorSelectedPlacedObject === itemToRemove.threeObject) deselectDecoratorPlacedObject(); decoratorScene.remove(itemToRemove.threeObject); itemToRemove.threeObject.traverse(child => { if (child.isMesh) { if(child.geometry) child.geometry.dispose(); if (child.material) { if (Array.isArray(child.material)) child.material.forEach(m => {if(m.dispose) m.dispose();}); else if(child.material.dispose) child.material.dispose();}} }); delete decoratorPlacedItems[data.id]; }
                 }
            }

            function createAnimatedGrass(scene, floorSize, instanceCount = 50000) {
                const textureLoader = new THREE.TextureLoader();
                // UPDATED URLs for grass textures
                const bladeDiffuseTexture = textureLoader.load('https://rawcdn.githack.com/pailhead/three.js-grass-example/master/blade_diffuse.png');
                const bladeAlphaTexture = textureLoader.load('https://rawcdn.githack.com/pailhead/three.js-grass-example/master/blade_alpha.png');

                const bladeGeometry = new THREE.PlaneGeometry(0.12, 1.0, 1, 3); // Blade dimensions
                bladeGeometry.translate(0, 0.5, 0); // Pivot at the base

                const grassMaterial = new THREE.MeshStandardMaterial({
                    map: bladeDiffuseTexture,
                    alphaMap: bladeAlphaTexture,
                    side: THREE.DoubleSide,
                    transparent: true,
                    metalness: 0.1, 
                    roughness: 0.8,
                    depthWrite: true 
                });

                animatedGrassAssets.material = grassMaterial; 

                grassMaterial.onBeforeCompile = shader => {
                    shader.uniforms.time = { value: 0 };
                    animatedGrassAssets.shader = shader; 

                    shader.vertexShader = `
                        uniform float time;
                        // Pseudo-random function
                        float random(vec2 st) {
                            return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);
                        }
                    ` + shader.vertexShader;

                    shader.vertexShader = shader.vertexShader.replace(
                        '#include <begin_vertex>',
                        `
                        #include <begin_vertex>

                        vec3 instanceWorldPos = (instanceMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;
                        
                        float noiseInputX = instanceWorldPos.x * 0.15 + time * 0.25;
                        float noiseInputZ = instanceWorldPos.z * 0.15 + time * 0.15;
                        float windStrength = random(vec2(noiseInputX, noiseInputZ)); 

                        float bendFactor = position.y + 0.5; // position.y is [0,1] after translate. So bendFactor is [0.5, 1.5]

                        float overallWindScale = 0.6; 
                        float bendAngle = windStrength * overallWindScale * bendFactor; 

                        float bendDirectionPhase = instanceWorldPos.x * 0.03 + instanceWorldPos.z * 0.015 + time * 0.1;
                        float bendDirX = sin(bendDirectionPhase);
                        float bendDirZ = cos(bendDirectionPhase);

                        transformed.x += bendDirX * bendAngle;
                        transformed.z += bendDirZ * bendAngle;
                        `
                    );
                };
                
                const grassMesh = new THREE.InstancedMesh(bladeGeometry, grassMaterial, instanceCount);
                grassMesh.receiveShadow = true; 
                grassMesh.castShadow = true;    
                scene.add(grassMesh);

                const dummy = new THREE.Object3D();
                // const halfFloor = floorSize / 2; // Not strictly needed here

                for (let i = 0; i < instanceCount; i++) {
                    dummy.position.set(
                        (Math.random() - 0.5) * floorSize,
                        0, 
                        (Math.random() - 0.5) * floorSize
                    );
                    dummy.rotation.y = Math.random() * Math.PI * 2;
                    const scale = 0.8 + Math.random() * 0.7; 
                    dummy.scale.set(scale, scale, scale);
                    dummy.updateMatrix();
                    grassMesh.setMatrixAt(i, dummy.matrix);
                }
                grassMesh.instanceMatrix.needsUpdate = true;
                
                console.log("Animated grass created with " + instanceCount + " instances.");
            }


            // --- Event Listeners Setup ---
            if (toggleSidebarBtn && contactListContainerEl) { toggleSidebarBtn.addEventListener('click', () => { contactListContainerEl.classList.toggle('collapsed'); const isCollapsed = contactListContainerEl.classList.contains('collapsed'); toggleSidebarBtn.innerHTML = isCollapsed ? feather.icons['arrow-right-circle'].toSvg() : feather.icons['arrow-left-circle'].toSvg(); }); }
            if (searchContactsInput) { searchContactsInput.addEventListener('input', function() { const searchTerm = this.value.toLowerCase().trim(); let filteredContacts = masterContacts; if (searchTerm) { filteredContacts = masterContacts.filter(contact => contact.name.toLowerCase().includes(searchTerm)); } renderContacts(filteredContacts); if (activeChatContactId) { const activeLi = contactListEl.querySelector(`li[data-contact-id="${activeChatContactId}"]`); if (activeLi) activeLi.classList.add('active-contact'); } }); searchContactsInput.addEventListener('keydown', function(e) { if (e.key === 'Escape') { this.value = ''; renderContacts(masterContacts); if (activeChatContactId) { const activeLi = contactListEl.querySelector(`li[data-contact-id="${activeChatContactId}"]`); if (activeLi) activeLi.classList.add('active-contact'); } } }); }
            navTabs.forEach(tab => { if(tab) tab.addEventListener('click', () => switchView(tab.dataset.view)) });
            if(sendButton) sendButton.addEventListener('click', () => sendMessage(messageInputEl.value.trim()));
            if(messageInputEl) messageInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(messageInputEl.value.trim()); }});
            if(attachImageChatBtn && imageUploadChatInput) attachImageChatBtn.addEventListener('click', () => imageUploadChatInput.click());
            if(imageUploadChatInput) imageUploadChatInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => sendMessage(messageInputEl.value.trim(), e.target.result); reader.readAsDataURL(file); }});
            if(submitPostButton && createPostImageInput && createPostCaptionInput) submitPostButton.addEventListener('click', () => { const file = createPostImageInput.files[0]; const caption = createPostCaptionInput.value.trim(); if (file) { const reader = new FileReader(); reader.onload = (e) => createPost(e.target.result, caption); reader.readAsDataURL(file); } else { createPost(null, caption); }});
            if(feedContainerEl) feedContainerEl.addEventListener('click', (e) => { const btn = e.target.closest('.like-button'); if (btn) toggleLike(btn.dataset.postId); });
            if(saveEncryptionKeyBtn && encryptionKeyInput) saveEncryptionKeyBtn.addEventListener('click', () => { const newKey = encryptionKeyInput.value; if (newKey) { encryptionKey = newKey; localStorage.setItem('chatEncryptionKey', encryptionKey); alert("Client-side encryption key set/updated."); } else { encryptionKey = null; localStorage.removeItem('chatEncryptionKey'); alert("Client-side encryption key cleared."); } updateEncryptionKeyStatus(); if(activeChatContactId) renderMessages(); });
            if(callButton) callButton.addEventListener('click', () => { if (activeChatContactId && masterContacts.find(c => c.id === activeChatContactId)?.name !== 'Echo Bot') startVideoCall(); });
            if(endCallBtn) endCallBtn.addEventListener('click', stopVideoCall);
            if(micToggleBtn) micToggleBtn.addEventListener('click', toggleMic);
            if(videoToggleBtn) videoToggleBtn.addEventListener('click', toggleVideo);
            if(closeGameButton) closeGameButton.addEventListener('click', closeGame);

            // --- Initial Setup ---
            updateEncryptionKeyStatus();
            switchView('chat'); // Set initial view

        });
    </script>
    
</body>
</html>
