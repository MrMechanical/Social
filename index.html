<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Viewport setup for responsiveness, safe areas, and disabling zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>SocialFusion Pro - Modern & Responsive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --primary-color: #007AFF;
            --secondary-color: #34C759;
            --destructive-color: #FF3B30;
            --background-color: #F2F2F7;
            --secondary-background-color: #E5E5EA;
            --surface-color: #FFFFFF;
            --text-color: #1C1C1E;
            --text-secondary-color: #8A8A8E;
            --border-color-light: rgba(60, 60, 67, 0.29);
            --incoming-bubble-bg: #E9E9EB; /* Surface color for incoming on dark mode if needed */
            --outgoing-bubble-bg: var(--primary-color);
            --outgoing-bubble-text: #ffffff;
            --hover-bg: rgba(0, 122, 255, 0.05);
            --active-bg: rgba(0, 122, 255, 0.1);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --border-radius: 10px;
            --border-radius-large: 16px;
            --shadow-soft: 0 2px 8px rgba(0,0,0,0.07);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.1);
            --nav-bar-height: 50px; /* Approximate height for padding calculations */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; width: 100%; overflow: hidden; font-family: var(--font-family); color: var(--text-color); background-color: var(--background-color); }

        #app-container {
            width: 100vw; height: 100vh; background-color: var(--surface-color);
            display: flex; flex-direction: column; /* Stack view-wrapper and nav */
            overflow: hidden; position: relative;
        }

        /* --- View Container --- */
        #view-wrapper {
            flex-grow: 1; /* Takes up space between potential top bar and bottom nav */
            overflow: hidden; /* Contains the scrolling views */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- Views --- */
        .view {
            display: none !important;
            width: 100%; height: 100%; /* Fill the wrapper */
            flex-direction: column;
            overflow: hidden; /* Default overflow hidden, specific views override */
            background-color: var(--background-color);
        }
        .view.active-view { display: flex !important; }

        /* Specific view overflow handling & Smooth Scrolling */
        #feed-view > #feed-content-wrapper, /* Target the wrapper for scrolling */
        #games-view > #games-view-content, /* Target the wrapper for scrolling */
        #settings-view, /* Settings view itself scrolls */
        #message-area,
        #contact-list-container > #contacts, /* Scrollable part of contact list */
        #contacts /* Fallback if used directly, prefer targeted approach */
         {
            overflow-y: auto;
             -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }


        /* Padding to ensure content is not hidden by bottom nav */
        /* This padding is for the scrollable content *within* views that reach the bottom of view-wrapper */
        #feed-content-wrapper, #games-view-content, #settings-view {
             padding-bottom: calc(var(--nav-bar-height) + env(safe-area-inset-bottom) + 15px);
        }
         /* Message area needs padding to clear the message input area, view-wrapper handles nav */
        #message-area {
            /* ... other styles ... */
             padding-bottom: 15px; /* Space above message input */
        }


         /* Adjust padding for elements directly inside views if they scroll fully */
        #games-view-content, #settings-view { /* games-view-content is now the scroller */
            padding-left: 15px;
            padding-right: 15px;
            padding-top: calc(env(safe-area-inset-top) + 15px); /* Handle top safe area */
        }
         #feed-content-wrapper { /* Feed view content wrapper is the scroller */
            padding-left: 10px;
            padding-right: 10px;
            padding-top: calc(env(safe-area-inset-top) + 10px);
        }


        /* --- Bottom Navigation Bar --- */
        #navigation {
            display: flex;
            background-color: var(--surface-color);
            padding: 5px 5px; /* Add side padding */
            padding-bottom: calc(env(safe-area-inset-bottom) + 5px); /* Respect safe area */
            flex-shrink: 0; /* Prevent shrinking */
            height: var(--nav-bar-height);
            box-shadow: 0 -1px 0 var(--border-color-light); /* Shadow on top */
            z-index: 10; /* Keep above content */
        }
        .nav-tab {
            flex-grow: 1; padding: 6px 0; /* Slightly adjust padding */
            background-color: transparent; border: none; cursor: pointer;
            font-size: 0.75em; /* Even smaller text for bottom nav */
            font-weight: 500; color: var(--text-secondary-color);
            outline: none; display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 1px; /* Smaller gap */
            transition: color 0.2s ease, background-color 0.2s ease;
            border-radius: var(--border-radius); margin: 0 2px; /* Adjust spacing */
        }
        .nav-tab i { width: 18px; height: 18px; } /* Slightly smaller icons */
        .nav-tab.active { color: var(--primary-color); background-color: var(--active-bg); }
        .nav-tab:not(.active):hover { color: var(--primary-color); background-color: var(--hover-bg); }

        /* --- Chat View Specifics --- */
        #chat-view { flex-direction: row; background-color: var(--surface-color); height: 100%; /* Ensure chat view fills its wrapper */ }

        #toggle-sidebar-btn {
           background: none; border: none; cursor: pointer; color: var(--text-secondary-color); padding: 8px; margin-right: 8px; border-radius: 50%; transition: background-color 0.2s ease, color 0.2s ease; line-height: 0;
        }
        #toggle-sidebar-btn:hover { background-color: var(--hover-bg); color: var(--primary-color); }
        #toggle-sidebar-btn i { width: 20px; height: 20px; }

        #contact-list-container {
            width: 280px; min-width: 250px; max-width: 35%;
            border-right: 1px solid var(--border-color-light);
            background-color: var(--surface-color); flex-shrink: 0;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), min-width 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.2s ease-out, border-right-width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1; display: flex; flex-direction: column;
            height: 100%; /* Fill vertical space in chat-view */
            padding-top: env(safe-area-inset-top); /* Respect notch on sidebar */
        }
        #contact-list-container.collapsed { width: 0px !important; min-width: 0px !important; opacity: 0; overflow: hidden; border-right-width: 0px !important; padding-left:0; padding-right:0; }
        #contact-list-container.collapsed > * { visibility: hidden; }
        #contact-list-container.collapsed #search-contacts-wrapper { display: none; }


        #search-contacts-wrapper { position: relative; padding: 10px 15px; border-bottom: 1px solid var(--border-color-light); background-color: var(--surface-color); flex-shrink: 0; }
        #search-contacts-wrapper .search-icon { position: absolute; left: 25px; top: 50%; transform: translateY(-50%); color: var(--text-secondary-color); width: 16px; height: 16px; pointer-events: none; }
        #search-contacts-input { width: 100%; padding: 8px 12px 8px 35px; border-radius: var(--border-radius); border: 1px solid var(--border-color-light); background-color: var(--secondary-background-color); font-size: 0.9em; color: var(--text-color); outline: none; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        #search-contacts-input::placeholder { color: var(--text-secondary-color); }
        #search-contacts-input:focus { border-color: var(--primary-color); background-color: var(--surface-color); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1); }
        #search-contacts-input::-webkit-search-cancel-button { -webkit-appearance: none; appearance: none; height: 14px; width: 14px; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%238A8A8E'%3e%3cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3e%3c/svg%3e"); background-size: 14px 14px; cursor: pointer; }

        #contact-list-container h3 { font-size: 1.2em; color: var(--text-color); padding: 10px 20px 15px; font-weight: 600; transition: opacity 0.1s linear; flex-shrink: 0; }
        #contacts { list-style: none; padding:0; margin:0; flex-grow: 1; /* UL element takes scroll */ padding-bottom: calc(var(--nav-bar-height) + env(safe-area-inset-bottom) + 10px); }
        #contacts li { padding: 10px 15px; cursor: pointer; font-size: 0.95em; display: flex; align-items: center; gap: 12px; transition: background-color 0.2s ease, opacity 0.1s linear; border-left: 4px solid transparent; border-radius: 0 var(--border-radius) var(--border-radius) 0; margin-right: 0px; }
        #contact-list-container.collapsed h3,
        #contact-list-container.collapsed #contacts li { opacity: 0; }
        #contacts li:hover { background-color: var(--hover-bg); }
        #contacts li.active-contact { background-color: var(--active-bg); color: var(--primary-color); font-weight: 600; border-left-color: var(--primary-color); }
        .no-contacts-found { padding: 20px; text-align: center; color: var(--text-secondary-color); font-style: italic; cursor: default !important; }
        .no-contacts-found:hover { background-color: transparent !important; }
        .contact-item-name { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .add-contact-btn {
            margin-left: auto; background-color: var(--secondary-color); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .add-contact-btn:hover { background-color: #2aa14a; }
        .add-contact-btn i { width: 16px; height: 16px; }
        .global-search-heading { padding: 10px 15px 5px; font-size: 0.8em; color: var(--text-secondary-color); font-weight: 500; text-transform: uppercase; }


        #contacts .contact-avatar,
        #chat-header .contact-avatar-header { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: var(--secondary-background-color); overflow: hidden; flex-shrink: 0; }
        #chat-header .contact-avatar-header { margin-right: 8px; }
        .contact-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .contact-avatar-text { font-size: 1.1em; }

        #chat-window { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--background-color); height: 100%; /* Ensure it tries to fill height */ }
        #chat-header { padding: 10px 15px; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color-light); font-weight: 600; display: flex; align-items: center; flex-shrink: 0; padding-top: calc(env(safe-area-inset-top) + 10px); /* Respect top safe area */ }
        #chat-header .contact-info { display: flex; align-items: center; gap: 0px; flex-grow: 1; overflow: hidden; }
        #current-chat-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95em; }
        #call-button { background: none; border: none; cursor: pointer; color: var(--primary-color); padding: 8px; border-radius: 50%; transition: background-color 0.2s ease; margin-left: auto; }
        #call-button:hover { background-color: var(--hover-bg); }
        #call-button i { width: 22px; height: 22px; }

        #message-area { flex-grow: 1; /* Takes remaining space */ padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; -webkit-overflow-scrolling: touch; /* padding-bottom handled by global rule */ }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: var(--border-radius-large); font-size: 0.92em; line-height: 1.45; position: relative; opacity: 1; transition: opacity 0.4s ease-out, transform 0.3s ease-out; word-wrap: break-word; box-shadow: var(--shadow-soft); }
        .message-bubble p { margin-bottom: 4px; }
        .message-timestamp { font-size: 0.7em; color: var(--text-secondary-color); display: block; text-align: right; margin-top: 6px; }
        .message-bubble.outgoing .message-timestamp { color: rgba(255,255,255,0.8); }
        .message-bubble img { max-width: 100%; border-radius: var(--border-radius); margin-top: 8px; display: block; cursor: pointer; }
        .message-bubble.outgoing { background-color: var(--outgoing-bubble-bg); color: var(--outgoing-bubble-text); align-self: flex-end; border-bottom-right-radius: 6px; }
        .message-bubble.incoming { background-color: var(--surface-color); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 6px; } /* Changed from E9E9EB to surface for consistency */
        .message-bubble.disappearing { opacity: 0; transform: translateY(-15px) scale(0.9); }
        .encryption-status { font-size: 0.75em; color: var(--text-secondary-color); text-align: center; padding: 8px 15px; background-color: var(--secondary-background-color); border-top: 1px solid var(--border-color-light); border-bottom: 1px solid var(--border-color-light); margin: 0; flex-shrink: 0; }
        #message-input-area { display: flex; align-items: center; padding: 10px 15px; border-top: 1px solid var(--border-color-light); background-color: var(--surface-color); flex-shrink: 0; gap: 8px; padding-bottom: calc(env(safe-area-inset-bottom) + 10px); } /* Input area respects safe area */
        #message-input-area input[type="text"] { flex-grow: 1; padding: 10px 16px; border: 1px solid var(--border-color-light); border-radius: 20px; outline: none; font-size: 0.95em; background-color: var(--secondary-background-color); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        #message-input-area input[type="text"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--surface-color); }
        #message-input-area button { background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s ease; width: 40px; height: 40px; }
        #message-input-area button:hover { background-color: var(--hover-bg); }
        #message-input-area button i { width: 22px; height: 22px; }

        /* --- Feed View Specifics --- */
        #feed-view {
             display: flex; justify-content: center; /* This view itself does not scroll */
             background-color: var(--background-color);
        }
        #feed-content-wrapper { width: 100%; max-width: 680px; display: flex; flex-direction: column; align-items: stretch; /* padding-bottom handled globally */ }
        #create-post-section { padding: 15px; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color-light); margin-bottom: 10px; flex-shrink: 0; width: 100%; border-radius: var(--border-radius-large); box-shadow: var(--shadow-soft); }
        #create-post-section h3 { font-size: 1.1em; font-weight: 600; margin-bottom: 15px; }
        #create-post-section input[type="file"],
        #create-post-section textarea { display: block; width: 100%; margin-bottom: 12px; padding: 10px; border: 1px solid var(--border-color-light); border-radius: var(--border-radius); font-size: 0.95em; background-color: var(--secondary-background-color); }
        #create-post-section textarea { resize: vertical; min-height: 70px; }
        #submit-post-button { padding: 10px 18px; background-color: var(--secondary-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: 500; width: 100%; transition: background-color 0.2s ease; font-size: 0.95em; min-height: 44px; }
        #submit-post-button:hover { background-color: #2aa14a; }
        #feed-container { display: flex; flex-direction: column; gap: 15px; padding: 0; width: 100%; }
        .feed-post { background-color: var(--surface-color); border: 1px solid var(--border-color-light); border-radius: var(--border-radius-large); box-shadow: var(--shadow-soft); overflow: hidden; }
        .post-header { display: flex; align-items: center; padding: 10px 15px; }
        .post-avatar { width: 36px; height: 36px; border-radius: 50%; background-color: var(--secondary-background-color); margin-right: 10px; object-fit: cover; overflow: hidden; }
        .post-username { font-weight: 600; font-size: 0.95em; }
        .post-image { width: 100%; max-height: 75vh; object-fit: cover; display: block; background-color: var(--secondary-background-color); border-top: 1px solid var(--border-color-light); border-bottom: 1px solid var(--border-color-light); }
        .post-actions { padding: 8px 15px; display: flex; align-items: center; gap: 15px; }
        .action-button { background: none; border: none; cursor: pointer; padding: 6px; color: var(--text-secondary-color); display:flex; align-items: center; justify-content: center; min-width: 36px; min-height: 36px;}
        .action-button i { width: 22px; height: 22px; }
        .like-button.liked { color: var(--destructive-color); }
        .like-button.liked i { fill: var(--destructive-color); }
        .post-likes { font-size: 0.9em; font-weight: 600; padding: 0 15px 6px; }
        .post-caption-container { padding: 0 15px 8px; font-size: 0.9em; line-height: 1.45; }
        .post-timestamp { font-size: 0.75em; color: var(--text-secondary-color); padding: 0 15px 12px; text-transform: uppercase; }

        /* --- Settings View Specifics --- */
        #settings-view {
             /* padding, overflow handled by global rules */
             background-color: var(--background-color);
        }
        #settings-view > div { background-color: var(--surface-color); padding: 20px; border-radius: var(--border-radius-large); box-shadow: var(--shadow-medium); margin-bottom: 20px; }
        #settings-view h2 { font-size: 1.6em; margin-bottom: 25px; color: var(--text-color); padding: 0; /* Align with cards */ }
        #settings-view h4 { font-size: 1.05em; margin-top: 0; margin-bottom: 10px; font-weight: 600; }
        #settings-view p { font-size: 0.9em; color: var(--text-secondary-color); margin-bottom: 12px; line-height: 1.5; }
        #settings-view label { display: block; margin-bottom: 6px; font-size: 0.85em; font-weight: 500; }
        #settings-view input[type="password"], #settings-view input[type="text"] { width: 100%; max-width: 380px; padding: 10px; margin-bottom: 12px; border: 1px solid var(--border-color-light); border-radius: var(--border-radius); font-size: 0.95em; background-color: var(--secondary-background-color); min-height: 44px; }
        #settings-view input[type="password"]:focus, #settings-view input[type="text"]:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15); background-color: var(--surface-color); }
        #save-encryption-key-btn { background-color: var(--primary-color) !important; color: white !important; padding: 10px 16px !important; border: none !important; border-radius: var(--border-radius) !important; cursor: pointer !important; font-size: 0.9em !important; min-height: 44px; }
        #key-status-message { font-size:0.85em; margin-top:8px; }


        /* --- Games View Specifics --- */
        #games-view { /* This view itself does not scroll */
             display: flex; justify-content: center;
             background-color: var(--background-color);
        }
        #games-view-content { width: 100%; max-width: 800px; height: auto; /* padding handled by global rules */ display: flex; flex-direction: column; align-items: center;}
        #games-view-content h2 { font-size: 1.6em; margin-bottom: 8px; }
        #games-view-content > p { margin-bottom: 15px; font-size: 0.9em; color: var(--text-secondary-color); text-align: center; }
        #close-game-button { margin-bottom: 12px; padding: 9px 18px; background-color: var(--primary-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 0.9em; font-weight: 500; min-height: 40px; }
        #close-game-button:hover { background-color: #005bb5; }
        #game-list-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; padding-bottom: 15px; }
        .game-thumbnail { width: 160px; padding: 12px; background-color: var(--surface-color); border: 1px solid var(--border-color-light); border-radius: var(--border-radius); cursor: pointer; text-align: center; transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; flex-direction: column; align-items: center; box-shadow: var(--shadow-soft); }
        .game-thumbnail:hover { transform: translateY(-4px); box-shadow: var(--shadow-medium); }
        .game-thumbnail img { width: 100%; height: 100px; object-fit: cover; border-radius: 6px; margin-bottom: 10px; background-color: var(--secondary-background-color); }
        .game-thumbnail p { font-size: 0.9em; font-weight: 500; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        #game-iframe-container { width: 100%; flex-grow: 1; min-height: 280px; max-width: 98vw; max-height: calc(100vh - (env(safe-area-inset-top) + env(safe-area-inset-bottom) + var(--nav-bar-height) + 70px)); /* Account for header/button/nav */ border: 1px solid var(--border-color-light); margin-left: auto; margin-right: auto; background-color: #000; border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--shadow-medium); }
        #game-iframe { width: 100%; height: 100%; border: none; }

        /* Video Call Overlay */
        #video-call-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); z-index: 900; display: none; flex-direction: column; align-items: center; justify-content: center; padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom) 20px; color: white; }
        #video-call-overlay.active { display: flex; }
        #video-status { font-size: 1em; margin-bottom: 15px; }
        #video-container { width: 95%; max-width: 700px; height: 75%; max-height: 550px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #111; border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #remote-video { width: 100%; height: 100%; object-fit: contain; }
        #local-video { position: absolute; width: clamp(80px, 20%, 120px); aspect-ratio: 9/16; object-fit: cover; border: 2px solid rgba(255,255,255,0.3); border-radius: var(--border-radius); bottom: 10px; right: 10px; z-index: 901; background-color: #000; }
        #video-controls { display: flex; gap: 15px; margin-top: 20px; }
        #video-controls button { background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: white; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; }
        #video-controls button:hover { background-color: rgba(255,255,255,0.2); }
        #video-controls button i { width: 22px; height: 22px; }
        #end-call-btn { background-color: var(--destructive-color); }
        #end-call-btn:hover { background-color: #E02B1D; }

        .hidden { display: none !important; }

        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) { /* Tablet */
            #contact-list-container { min-width: 220px; }
            #contact-list-container.collapsed { width: 0px !important; min-width: 0px !important; }
            #feed-content-wrapper { max-width: 95%; }
            .game-thumbnail { width: calc(33.33% - 10px); }
        }

        @media (max-width: 480px) { /* Mobile phones */
            :root { --nav-bar-height: 46px; }
            /* Bottom Nav */
            .nav-tab span {display: none;}
            .nav-tab i {margin-bottom: 0; width: 22px; height: 22px;} /* Slightly larger icons if no text */
            .nav-tab { padding: 6px 0; gap: 0; }

            /* Chat View Mobile */
            #toggle-sidebar-btn { margin-right: 2px; padding: 6px; }
            #toggle-sidebar-btn i { width: 20px; height: 20px; }

            #contact-list-container {
                width: 60px; min-width: 60px; /* Even more compact for avatars only */
                padding-top: env(safe-area-inset-top);
            }
             #contact-list-container.collapsed { width: 0px !important; min-width: 0px !important; }
             #contact-list-container.collapsed #search-contacts-wrapper { display: none; }

            #contact-list-container #search-contacts-wrapper {
                padding: 8px 5px;
            }
             #contact-list-container #search-contacts-input {
                font-size: 0.8em;
                padding: 6px 6px 6px 28px; /* Compact padding, space for icon */
                width: 100%;
            }
             #contact-list-container #search-contacts-input::placeholder {
                color: transparent; opacity: 0; /* Hide placeholder on mobile compact mode */
            }
            #contact-list-container #search-contacts-wrapper .search-icon {
                left: 8px; /* Icon closer to left */
                width: 14px; height: 14px;
            }

            #contact-list-container h3 { display: none; }
            #contacts { padding-top: 5px; padding-bottom: calc(var(--nav-bar-height) + env(safe-area-inset-bottom) + 10px); }
            #contacts li { justify-content: center; padding: 8px 0; gap: 0; margin-right: 0; border-radius: 0; border-left-width: 3px; }
            #contacts li .contact-item-name {display: none;} /* Hide name span */
            #contacts li .add-contact-btn { margin-left: 5px; width: 30px; height: 30px; } /* Adjust add button for icon only list */
            #contacts .contact-avatar { width: 34px; height: 34px; }
            .contact-avatar-text { font-size: 1em; }
            .global-search-heading { padding: 8px 5px 3px; font-size: 0.7em; text-align: center;}


            #chat-header { padding: 8px 10px; padding-top: calc(env(safe-area-inset-top) + 8px); }
            #chat-header .contact-avatar-header { width: 32px; height: 32px; margin-right: 6px;}
            #current-chat-name { font-size: 0.95em; font-weight: 500; }
            #call-button { padding: 6px; } #call-button i { width: 20px; height: 20px; }

            #message-area { padding: 10px; gap: 8px; /* padding-bottom is global */ }
            .message-bubble { max-width: 80%; padding: 8px 12px; font-size: 0.9em; border-radius: 14px; }

            #message-input-area { padding: 8px 10px; gap: 6px; padding-bottom: calc(env(safe-area-inset-bottom) + 8px); }
            #message-input-area input[type="text"] { padding: 9px 14px; font-size: 0.9em; min-height: 40px;}
            #message-input-area button { padding: 7px; width: 38px; height: 38px;} #message-input-area button i { width: 18px; height: 18px; }

            /* Feed View Mobile */
            #feed-view { /* padding is on feed-content-wrapper */ }
            #feed-content-wrapper { max-width: 100%; padding-left: 0; padding-right: 0; padding-top: env(safe-area-inset-top); padding-bottom: calc(var(--nav-bar-height) + env(safe-area-inset-bottom) + 5px); }
            #create-post-section { border-radius: 0; box-shadow: none; margin: 0 0 8px 0; padding: 12px; border-bottom: 1px solid var(--border-color-light); }
            #feed-container { padding: 0; gap: 0px; }
            .feed-post { border-radius: 0; box-shadow: none; border:none; border-bottom: 6px solid var(--background-color); margin-bottom: 0; }
            .feed-post:last-child { border-bottom: none; }
            .post-actions { gap: 8px; padding: 6px 10px;}
            .action-button { min-width: 30px; min-height: 30px; }
            .action-button i { width: 20px; height: 20px;}
            .post-likes { padding: 0 10px 4px; font-size: 0.85em;}
            .post-caption-container { padding: 0 10px 6px; font-size: 0.85em;}
            .post-timestamp { padding: 0 10px 10px; font-size: 0.7em;}


            /* Games View Mobile */
            #games-view-content { max-width: 100%; padding-left: 10px; padding-right: 10px; padding-top: env(safe-area-inset-top); padding-bottom: calc(var(--nav-bar-height) + env(safe-area-inset-bottom) + 10px); }
            .game-thumbnail { width: calc(50% - 8px); padding: 10px; }
            .game-thumbnail img { height: 80px; margin-bottom: 8px;}
            .game-thumbnail p { font-size: 0.85em;}
            #game-iframe-container { max-height: calc(100vh - (env(safe-area-inset-top) + env(safe-area-inset-bottom) + var(--nav-bar-height) + 60px)); }


             /* Settings View Mobile */
            #settings-view { padding-left: 0; padding-right: 0; padding-top: env(safe-area-inset-top); padding-bottom: calc(var(--nav-bar-height) + env(safe-area-inset-bottom) + 5px); }
            #settings-view > div { border-radius: 0; box-shadow: none; margin-bottom: 8px; border-bottom: 1px solid var(--border-color-light); padding: 15px; }
            #settings-view h2 { padding: 15px 15px 10px; font-size: 1.3em; margin-bottom: 0; background-color: var(--surface-color); border-bottom: 1px solid var(--border-color-light); }
            #settings-view input[type="password"], #settings-view input[type="text"] { min-height: 40px; }
            #save-encryption-key-btn { min-height: 40px; }
        }

    </style>
</head>
<body>
    <div id="app-container">
        <!-- View Wrapper - Handles flex grow and contains views -->
        <div id="view-wrapper">
            <div id="chat-view" class="view active-view">
                <div id="contact-list-container">
                    <div id="search-contacts-wrapper">
                        <i data-feather="search" class="search-icon"></i>
                        <input type="search" id="search-contacts-input" placeholder="Search contacts...">
                    </div>
                    <h3>Messages</h3>
                    <ul id="contacts"></ul>
                </div>
                <div id="chat-window">
                    <div id="chat-header">
                        <button id="toggle-sidebar-btn" title="Toggle Contacts"><i data-feather="arrow-left-circle"></i></button>
                        <div class="contact-info">
                            <div id="current-chat-avatar-header" class="contact-avatar-header"></div>
                            <span id="current-chat-name">Select a Chat</span>
                        </div>
                        <button id="call-button" class="hidden" title="Start Video Call"><i data-feather="video"></i></button>
                    </div>
                    <div class="encryption-status hidden" id="chat-encryption-status"></div>
                    <div id="message-area"></div>
                    <div id="message-input-area"><input type="file" id="image-upload-chat" accept="image/*" style="display: none;"><button id="attach-image-chat-btn" title="Attach Image"><i data-feather="paperclip"></i></button><input type="text" id="message-text" placeholder="Type a message..."><button id="send-button" title="Send Message"><i data-feather="send"></i></button></div>
                </div>
            </div>

             <div id="feed-view" class="view">
                <div id="feed-content-wrapper">
                    <div id="create-post-section"><h3>Create New Post</h3><input type="file" id="image-upload-feed" accept="image/*" title="Select image to upload"><textarea id="post-caption" placeholder="Write a caption..."></textarea><button id="submit-post-button">Post to Feed</button></div>
                    <div id="feed-container"></div>
                </div>
            </div>

            <div id="games-view" class="view">
                 <div id="games-view-content">
                    <h2>HTML5 Games</h2>
                    <p>Select a game to play! (Note: Some games may not load due to embedding restrictions.)</p>
                    <button id="close-game-button" style="display: none;">Close Game</button>
                    <div id="game-list-container"></div>
                    <div id="game-iframe-container" style="display: none;">
                        <iframe id="game-iframe" allowfullscreen></iframe>
                    </div>
                 </div>
            </div>

             <div id="settings-view" class="view">
                 <h2>App Settings</h2>
                 <div>
                    <h4>Chat Encryption (Client-Side Demo)</h4>
                    <p>Enter a shared secret key for client-side "end-to-end" encrypted chat. This key is stored in your browser's local storage and is <strong>not shared with any server or other users automatically</strong>. For true multi-user E2EE, a secure key exchange mechanism (typically server-assisted) would be required.</p>
                    <label for="encryption-key-input">Current Encryption Key:</label>
                    <input type="password" id="encryption-key-input" placeholder="Enter shared secret key">
                    <button id="save-encryption-key-btn">Set/Update Key</button>
                    <p id="key-status-message"></p>
                 </div>
                 <div>
                    <h4>Profile Settings</h4>
                    <p>User profile information and preferences would go here.</p>
                    <label for="username-input">Username:</label>
                    <input type="text" id="username-input" placeholder="Your Username">
                 </div>
            </div>
        </div> <!-- End #view-wrapper -->

        <!-- Video Call Overlay -->
        <div id="video-call-overlay">
             <div id="video-status">Connecting (Loopback Demo)...</div><div id="video-container"><video id="remote-video" autoplay playsinline></video><video id="local-video" autoplay playsinline muted></video></div>
             <div id="video-controls"><button id="mic-toggle-btn" title="Toggle Mic"><i data-feather="mic"></i></button><button id="video-toggle-btn" title="Toggle Video"><i data-feather="video"></i></button><button id="end-call-btn" title="End Call"><i data-feather="phone-off"></i></button></div>
        </div>

        <!-- Navigation Bar -->
        <nav id="navigation">
            <button class="nav-tab active" data-view="chat" title="Chat"><i data-feather="message-square"></i> <span>Chat</span></button>
            <button class="nav-tab" data-view="feed" title="Feed"><i data-feather="layout"></i> <span>Feed</span></button>
            <button class="nav-tab" data-view="games" title="Games"><i data-feather="cpu"></i> <span>Games</span></button>
            <button class="nav-tab" data-view="settings" title="Settings"><i data-feather="settings"></i> <span>Settings</span></button>
        </nav>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        function safeFeatherReplace() { try { feather.replace(); } catch (e) { console.error("Feather icons could not be initialized:", e); }}
        safeFeatherReplace();

        let currentView = 'chat';
        let encryptionKey = localStorage.getItem('chatEncryptionKey') || null;
        const masterContacts = [
            { id: 1, name: 'Alice Wonderland', avatar: 'https://i.pravatar.cc/80?u=alice', messages: [] },
            { id: 2, name: 'Bob The Builder', avatar: 'https://i.pravatar.cc/80?u=bob', messages: [] },
            { id: 3, name: 'Echo Bot', avatar: 'https://i.pravatar.cc/80?u=echobot', messages: [
                { id: Date.now(), text: "Hi there! I'm Echo Bot. I can repeat what you say.", type: 'incoming', timestamp: Date.now(), isEncrypted: false }
            ]},
            { id: 4, name: 'Charlie Chaplin', avatar: 'https://i.pravatar.cc/80?u=charlie', messages: [] },
            { id: 5, name: 'Diana Prince', avatar: 'https://i.pravatar.cc/80?u=diana', messages: [] },
        ];
        // Mock global user directory for searching outside contacts
        const globalUserDirectory = [
            { id: 101, name: 'Gandalf The Grey', avatar: 'https://i.pravatar.cc/80?u=gandalf' },
            { id: 102, name: 'Frodo Baggins', avatar: 'https://i.pravatar.cc/80?u=frodo' },
            { id: 103, name: 'Prof. Minerva McGonagall', avatar: 'https://i.pravatar.cc/80?u=minerva' },
            { id: 104, name: 'Clark Kent', avatar: 'https://i.pravatar.cc/80?u=clark' },
            { id: 105, name: 'Bruce Wayne', avatar: 'https://i.pravatar.cc/80?u=bruce' },
            { id: 106, name: 'Tony Stark', avatar: 'https://i.pravatar.cc/80?u=tony' },
            { id: 107, name: 'Natasha Romanoff', avatar: 'https://i.pravatar.cc/80?u=natasha' },
        ];

        let activeChatContactId = null;
        let feedPosts = [
            { id: Date.now() + 1, user: { name: 'AdventureSeeker', avatar: 'https://i.pravatar.cc/80?u=adv' }, image: 'https://picsum.photos/seed/travelspot/600/500', caption: 'Exploring the hidden gems! This is a longer caption to test how text wrapping and layout behaves on smaller screens and with more content than usual. The views here are breathtaking!', likes: 187, likedByUser: false, timestamp: Date.now() - (86400000 * 1.5)},
            { id: Date.now() + 2, user: { name: 'CulinaryMaster', avatar: 'https://i.pravatar.cc/80?u=chef' }, image: 'https://picsum.photos/seed/foodieplate/600/450', caption: 'Perfectly seared scallops with a lemon butter sauce. Absolutely divine!', likes: 305, likedByUser: true, timestamp: Date.now() - (86400000 * 0.75)}
        ];
        const newGamesData = [ /* --- IMPORTANT: Add your large newGamesData array back here --- */ ]; // Placeholder, user needs to re-add
        // --- End of games data ---
        let games = newGamesData.map((game, index) => ({ id: `game_${index}`, name: game.title, url: game.embed, thumbnailUrl: game.image }));


        const EPHEMERAL_MESSAGE_DURATION = 30000;
        let localStream, peerConnection, isVideoCallActive = false;
        const iceServers = { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] };

        const viewWrapper = document.getElementById('view-wrapper');
        const navTabs = document.querySelectorAll('.nav-tab');
        const views = viewWrapper.querySelectorAll('.view');
        const contactListEl=document.getElementById('contacts');
        const contactListContainerEl = document.getElementById('contact-list-container');
        const searchContactsInput = document.getElementById('search-contacts-input');
        const currentChatNameEl=document.getElementById('current-chat-name'),currentChatAvatarHeaderEl=document.getElementById('current-chat-avatar-header'),messageAreaEl=document.getElementById('message-area'),messageInputEl=document.getElementById('message-text'),sendButton=document.getElementById('send-button'),attachImageChatBtn=document.getElementById('attach-image-chat-btn'),imageUploadChatInput=document.getElementById('image-upload-chat'),chatEncryptionStatusEl=document.getElementById('chat-encryption-status'),callButton=document.getElementById('call-button'),feedContainerEl=document.getElementById('feed-container'),createPostImageInput=document.getElementById('image-upload-feed'),createPostCaptionInput=document.getElementById('post-caption'),submitPostButton=document.getElementById('submit-post-button'),encryptionKeyInput=document.getElementById('encryption-key-input'),saveEncryptionKeyBtn=document.getElementById('save-encryption-key-btn'),keyStatusMessageEl=document.getElementById('key-status-message'),videoCallOverlay=document.getElementById('video-call-overlay'),localVideoEl=document.getElementById('local-video'),remoteVideoEl=document.getElementById('remote-video'),micToggleBtn=document.getElementById('mic-toggle-btn'),videoToggleBtn=document.getElementById('video-toggle-btn'),endCallBtn=document.getElementById('end-call-btn'),videoStatusEl=document.getElementById('video-status');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
        const gamesViewEl = document.getElementById('games-view');
        const gamesViewContentEl = document.getElementById('games-view-content');
        const gameListContainerEl = document.getElementById('game-list-container');
        const gameIframeContainerEl = document.getElementById('game-iframe-container');
        const gameIframeEl = document.getElementById('game-iframe');
        const closeGameButton = document.getElementById('close-game-button');
        const gamesViewHeading = gamesViewContentEl.querySelector('h2');
        const gamesViewIntroP = gamesViewContentEl.querySelector('p');

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function encryptMessage(text, key) { if (!key || !text) return text; try { return CryptoJS.AES.encrypt(text, key).toString(); } catch (e) { console.error("Encryption failed:", e); return `Error encrypting: ${text.substring(0,10)}...`; }}
        function decryptMessage(ciphertext, key) { if (!key || !ciphertext) return ciphertext; try { const bytes = CryptoJS.AES.decrypt(ciphertext, key); const originalText = bytes.toString(CryptoJS.enc.Utf8); return originalText || "[Unable to decrypt - possibly wrong key]"; } catch (e) { console.error("Decryption failed:", e); return `[Decryption Error] ${ciphertext.substring(0,10)}...`; }}
        function updateEncryptionKeyStatus() { if (encryptionKey) { encryptionKeyInput.value = encryptionKey; keyStatusMessageEl.textContent = "Client-side encryption key is set."; keyStatusMessageEl.style.color = "var(--secondary-color)"; } else { encryptionKeyInput.value = ''; keyStatusMessageEl.textContent = "Client-side encryption key is NOT set. Applicable messages will not be encrypted."; keyStatusMessageEl.style.color = "var(--destructive-color)"; } if (activeChatContactId) { const contact = masterContacts.find(c => c.id === activeChatContactId); updateChatEncryptionBanner(contact); }}
        function updateChatEncryptionBanner(contact) { if (contact && contact.name !== 'Echo Bot') { chatEncryptionStatusEl.classList.toggle('hidden', !encryptionKey); chatEncryptionStatusEl.textContent = encryptionKey ? `🔒 Messages client-side encrypted.` : `⚠️ No client-side key. Messages not encrypted.`; } else { chatEncryptionStatusEl.classList.add('hidden'); }}
        function formatTimestamp(timestamp) { return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });}
        function formatPostTimestamp(timestamp) { const now = new Date(); const postDate = new Date(timestamp); const diffSeconds = Math.round((now - postDate) / 1000); if (diffSeconds < 60) return "JUST NOW"; const diffMinutes = Math.round(diffSeconds / 60); if (diffMinutes < 60) return `${diffMinutes}m ago`; const diffHours = Math.round(diffMinutes / 60); if (diffHours < 24) return `${diffHours}h ago`; const diffDays = Math.round(diffHours / 24); if (diffDays < 7) return `${diffDays}d ago`; return postDate.toLocaleDateString(); }

        function switchView(viewName) {
            const oldView = currentView; currentView = viewName;
            views.forEach(view => view.classList.remove('active-view'));
            navTabs.forEach(tab => tab.classList.remove('active'));
            const targetViewEl = viewWrapper.querySelector(`#${viewName}-view`);
            if (targetViewEl) targetViewEl.classList.add('active-view');
            else console.error(`Target view element "${viewName}-view" NOT FOUND!`);
            const targetNavTabEl = document.querySelector(`.nav-tab[data-view="${viewName}"]`);
            if (targetNavTabEl) targetNavTabEl.classList.add('active');
            else console.error(`Target nav tab for view "${viewName}" NOT FOUND!`);

            if (oldView === 'games' && viewName !== 'games' && (gameIframeContainerEl.style.display === 'block' || gameIframeContainerEl.style.display === 'flex')) closeGame();
            if (viewName === 'feed') renderFeed();
            if (viewName === 'chat') {
                handleContactSearch(); // Render contacts based on current search or full list
                if (toggleSidebarBtn && contactListContainerEl) {
                     const isCollapsed = contactListContainerEl.classList.contains('collapsed');
                     toggleSidebarBtn.innerHTML = isCollapsed ? feather.icons['arrow-right-circle'].toSvg() : feather.icons['arrow-left-circle'].toSvg();
                }
            }
            if (viewName === 'settings') updateEncryptionKeyStatus();
            if (viewName === 'games') renderGamesList();
        }

        function renderContacts(contactsToDisplay = [], globalResults = []) {
            contactListEl.innerHTML = '';
            let foundItems = false;

            if (contactsToDisplay.length > 0) {
                foundItems = true;
                contactsToDisplay.forEach(c => {
                    const li = document.createElement('li');
                    const avatarContent = c.avatar && c.avatar.startsWith('http') ? `<img src="${c.avatar}" alt="${c.name}" class="contact-avatar-img">` : `<span class="contact-avatar-text">${c.avatar || c.name.charAt(0)}</span>`;
                    li.innerHTML = `<div class="contact-avatar">${avatarContent}</div><span class="contact-item-name">${c.name}</span>`;
                    li.dataset.contactId = c.id;
                    if (c.id === activeChatContactId) li.classList.add('active-contact');
                    li.addEventListener('click', () => selectChat(c.id));
                    contactListEl.appendChild(li);
                });
            }

            if (globalResults.length > 0) {
                foundItems = true;
                const heading = document.createElement('div');
                heading.classList.add('global-search-heading');
                heading.textContent = 'People You May Know';
                contactListEl.appendChild(heading);

                globalResults.forEach(gUser => {
                    const li = document.createElement('li');
                    li.dataset.globalUserId = gUser.id;
                    const avatarContent = gUser.avatar && gUser.avatar.startsWith('http') ? `<img src="${gUser.avatar}" alt="${gUser.name}" class="contact-avatar-img">` : `<span class="contact-avatar-text">${gUser.avatar || gUser.name.charAt(0)}</span>`;
                    li.innerHTML = `
                        <div class="contact-avatar">${avatarContent}</div>
                        <span class="contact-item-name">${gUser.name}</span>
                        <button class="add-contact-btn" title="Add ${gUser.name} to contacts">
                            <i data-feather="user-plus"></i>
                        </button>`;
                    li.querySelector('.add-contact-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent li click event
                        addGlobalUserToContacts(gUser.id);
                    });
                    // Make the whole li clickable to add contact as well, if desired, or just rely on button
                    // li.addEventListener('click', () => addGlobalUserToContacts(gUser.id));
                    contactListEl.appendChild(li);
                });
                feather.replace(); // For the 'user-plus' icon
            }

            if (!foundItems && searchContactsInput && searchContactsInput.value.trim() !== '') {
                const li = document.createElement('li');
                li.classList.add('no-contacts-found');
                li.textContent = 'No one found.';
                contactListEl.appendChild(li);
            }
        }

        function addGlobalUserToContacts(userId) {
            const userToAdd = globalUserDirectory.find(u => u.id === userId);
            if (userToAdd && !masterContacts.some(c => c.id === userId)) { // Check if not already added (e.g. by ID)
                masterContacts.push({ ...userToAdd, messages: [] });
                // Optional: Remove from globalUserDirectory if you want it to be a one-time add
                // globalUserDirectory = globalUserDirectory.filter(u => u.id !== userId);
                alert(`${userToAdd.name} added to your contacts!`);
                searchContactsInput.value = ''; // Clear search
                handleContactSearch(); // Re-render contact list
                selectChat(userToAdd.id); // Optionally auto-select the new contact
            } else if (userToAdd) {
                alert(`${userToAdd.name} is already in your contacts or added.`);
                searchContactsInput.value = ''; // Clear search
                handleContactSearch();
            }
        }


        function handleContactSearch() {
            const searchTerm = searchContactsInput.value.toLowerCase().trim();
            let filteredContacts = [];
            let globalResults = [];

            if (searchTerm) {
                filteredContacts = masterContacts.filter(contact =>
                    contact.name.toLowerCase().includes(searchTerm)
                );
                if (searchTerm.length >= 2) { // Start global search for terms 2 chars or longer
                    const masterContactIds = masterContacts.map(c => c.id);
                    const masterContactNames = masterContacts.map(c => c.name.toLowerCase()); // to avoid adding by name if ID differs but name is same

                    globalResults = globalUserDirectory.filter(gUser =>
                        !masterContactIds.includes(gUser.id) &&
                        !masterContactNames.includes(gUser.name.toLowerCase()) &&
                        gUser.name.toLowerCase().includes(searchTerm)
                    );
                }
            } else {
                filteredContacts = [...masterContacts];
            }
            renderContacts(filteredContacts, globalResults);
            // Update active state in filtered list
            if (activeChatContactId) {
                const activeLi = contactListEl.querySelector(`li[data-contact-id="${activeChatContactId}"]`);
                if (activeLi) activeLi.classList.add('active-contact');
            }
        }


        function selectChat(contactId) {
            activeChatContactId = contactId;
            const c = masterContacts.find(ct => ct.id === contactId);
            currentChatNameEl.textContent = c ? c.name : 'Select a Chat';
            if (c && c.avatar) { currentChatAvatarHeaderEl.innerHTML = c.avatar.startsWith('http') ? `<img src="${c.avatar}" alt="${c.name}" class="contact-avatar-img">` : `<span class="contact-avatar-text">${c.avatar || c.name.charAt(0)}</span>`; }
            else { currentChatAvatarHeaderEl.innerHTML = c ? `<span class="contact-avatar-text">${c.name.charAt(0)}</span>` : ''; }
            callButton.classList.toggle('hidden', !c || c.name === 'Echo Bot');
            updateChatEncryptionBanner(c);
            // If user selected a chat, clear search and show all contacts
            if (searchContactsInput.value !== '') {
                searchContactsInput.value = '';
                handleContactSearch(); // This will re-render with full list and active contact
            } else {
                // Just re-apply active class if search was already empty
                document.querySelectorAll('#contacts li').forEach(item => item.classList.remove('active-contact'));
                const activeLi = contactListEl.querySelector(`li[data-contact-id="${activeChatContactId}"]`);
                if (activeLi) activeLi.classList.add('active-contact');
            }
            renderMessages();
            // messageInputEl.focus(); // Avoid auto-focus on mobile
        }


        function renderMessages() { messageAreaEl.innerHTML=''; if(!activeChatContactId)return; const contact = masterContacts.find(c => c.id === activeChatContactId); if(contact && contact.messages){contact.messages.forEach(msg=>{let dMsg={...msg}; if(msg.isEncrypted){if(encryptionKey)dMsg.text=decryptMessage(msg.text,encryptionKey); else dMsg.text=`🔒 [Encrypted] (${msg.text.length} chars)`;} displayMessage(dMsg);});} requestAnimationFrame(() => { messageAreaEl.scrollTop=messageAreaEl.scrollHeight; });}
        function displayMessage(message) { const b=document.createElement('div');b.classList.add('message-bubble',message.type);b.id=`msg-${message.id}`; const t=document.createElement('p');t.textContent=message.text;b.appendChild(t); if(message.image){const i=document.createElement('img');i.src=message.image;b.appendChild(i);} const time=document.createElement('span');time.classList.add('message-timestamp');time.textContent=formatTimestamp(message.timestamp);b.appendChild(time);messageAreaEl.appendChild(b); requestAnimationFrame(() => { messageAreaEl.scrollTop=messageAreaEl.scrollHeight; }); if(message.type==='outgoing'||(message.type==='incoming'&&masterContacts.find(c=>c.id===activeChatContactId)?.name!=='Echo Bot')){setTimeout(()=>{b.classList.add('disappearing');setTimeout(()=>b.remove(),500);},EPHEMERAL_MESSAGE_DURATION);}}
        function sendMessage(text, image = null) { if(!activeChatContactId||(!text&&!image))return;const contact = masterContacts.find(c=>c.id===activeChatContactId);if(!contact)return;let pText=text;let isEnc=false;if(contact.name!=='Echo Bot'){if(encryptionKey&&text){pText=encryptMessage(text,encryptionKey);isEnc=true;}else if(!encryptionKey&&text){isEnc=false;}}const nM={id:Date.now(),text:pText,image:image,type:'outgoing',timestamp:Date.now(),isEncrypted:isEnc}; if(!contact.messages) contact.messages = []; contact.messages.push(nM);let dMsg={...nM};if(isEnc&&text)dMsg.text=text;displayMessage(dMsg);messageInputEl.value='';imageUploadChatInput.value='';if(contact.name==="Echo Bot"){setTimeout(()=>simulateBotReply(contact.id,text||(image?"[Image Sent]":"[Empty Message]")),1000);}}
        function simulateBotReply(contactId,originalUserMessage) { let rText=`Echo: "${originalUserMessage}"`;if(originalUserMessage.toLowerCase().includes("hello")||originalUserMessage.toLowerCase().includes("hi"))rText="Echo says: Hello back to you! 👋";else if(originalUserMessage.toLowerCase().includes("how are you"))rText="Echo status: Operational and echoing! How are YOU?";else if(originalUserMessage.length>50)rText=`Echo (long message received!): "${originalUserMessage.substring(0,20)}..."`;const rM={id:Date.now()+1,text:rText,type:'incoming',timestamp:Date.now(),isEncrypted:false};const contact=masterContacts.find(ct=>ct.id===contactId);if(contact&&activeChatContactId===contactId){if(!contact.messages) contact.messages = []; contact.messages.push(rM);displayMessage(rM);}}
        function renderFeed() { feedContainerEl.innerHTML = ''; if (!Array.isArray(feedPosts) || feedPosts.length === 0) { feedContainerEl.innerHTML = '<p style="text-align:center; padding:20px; color: var(--text-secondary-color);">No posts yet. Create one!</p>'; safeFeatherReplace(); return; } feedPosts.slice().reverse().forEach(post => { const postEl = document.createElement('div'); postEl.classList.add('feed-post'); postEl.innerHTML = `<div class="post-header"><img src="${post.user.avatar}" alt="${post.user.name}" class="post-avatar"><span class="post-username">${post.user.name}</span></div> ${post.image ? `<img src="${post.image}" class="post-image">` : ''} <div class="post-actions"><button class="action-button like-button ${post.likedByUser ? 'liked' : ''}" data-post-id="${post.id}"><i data-feather="heart"${post.likedByUser ? ' style="fill: var(--destructive-color);"' : ''}></i></button><button class="action-button"><i data-feather="message-circle"></i></button><button class="action-button"><i data-feather="send"></i></button></div> <div class="post-likes">${post.likes.toLocaleString()} likes</div> <div class="post-caption-container"><strong class="post-username">${post.user.name}</strong> <span>${post.caption}</span></div> <div class="post-timestamp">${formatPostTimestamp(post.timestamp)}</div>`; feedContainerEl.appendChild(postEl); }); safeFeatherReplace(); }
        function toggleLike(postId) {const p=feedPosts.find(post=>post.id==postId);if(p){p.likedByUser=!p.likedByUser;p.likes+=p.likedByUser?1:-1;renderFeed();}}
        function createPost(imageUrl,caption){if(!imageUrl&&!caption){alert("Please select an image or write a caption.");return;}const nP={id:Date.now(),user:{name:'You (Demo)',avatar:'https://i.pravatar.cc/80?u=demoUser'},image:imageUrl,caption:caption||"",likes:0,likedByUser:false,timestamp:Date.now()};feedPosts.push(nP);renderFeed();createPostImageInput.value='';createPostCaptionInput.value='';}
        function renderGamesList() { gameListContainerEl.innerHTML = ''; games.forEach(game => { const gameEl = document.createElement('div'); gameEl.classList.add('game-thumbnail'); gameEl.dataset.gameUrl = game.url; gameEl.innerHTML = `<img src="${game.thumbnailUrl}" alt="${game.name}" onerror="this.src='https://via.placeholder.com/150/CCCCCC/FFFFFF?Text=No+Image'; this.onerror=null;"><p title="${game.name}">${game.name}</p>`; gameEl.addEventListener('click', () => loadGame(game.url, game.name)); gameListContainerEl.appendChild(gameEl); }); closeGameButton.style.display = 'none'; gameIframeContainerEl.style.display = 'none'; gameIframeEl.src = 'about:blank'; gameListContainerEl.style.display = 'flex'; if(gamesViewHeading) gamesViewHeading.style.display = 'block'; if(gamesViewIntroP) gamesViewIntroP.style.display = 'block'; }
        function loadGame(gameUrl, gameName) { gameIframeEl.src = gameUrl; gameIframeContainerEl.style.display = 'block'; gameListContainerEl.style.display = 'none'; closeGameButton.style.display = 'block'; if(gamesViewHeading) gamesViewHeading.style.display = 'none'; if(gamesViewIntroP) gamesViewIntroP.style.display = 'none'; }
        function closeGame() { gameIframeEl.src = 'about:blank'; gameIframeContainerEl.style.display = 'none'; gameListContainerEl.style.display = 'flex'; closeGameButton.style.display = 'none'; if(gamesViewHeading) gamesViewHeading.style.display = 'block'; if(gamesViewIntroP) gamesViewIntroP.style.display = 'block'; }
        async function startVideoCall() {if(isVideoCallActive)return;isVideoCallActive=true;videoCallOverlay.classList.add('active');videoStatusEl.textContent="Accessing camera/mic...";safeFeatherReplace();try{localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});localVideoEl.srcObject=localStream;videoStatusEl.textContent="Local media connected. Loopback setup...";peerConnection=new RTCPeerConnection(iceServers);localStream.getTracks().forEach(t=>peerConnection.addTrack(t,localStream));peerConnection.ontrack=e=>{if(e.streams&&e.streams[0]){remoteVideoEl.srcObject=e.streams[0];videoStatusEl.textContent="Video Loopback Active";}else if(!remoteVideoEl.srcObject&&e.track.kind==='video'){remoteVideoEl.srcObject=new MediaStream([e.track]);videoStatusEl.textContent="Video Loopback Active (Track)";}};peerConnection.onicecandidate=e=>{if(e.candidate)peerConnection.addIceCandidate(e.candidate).catch(err=>console.error("ICE add error",err));};const o=await peerConnection.createOffer();await peerConnection.setLocalDescription(o);await peerConnection.setRemoteDescription(o);/*const a=await peerConnection.createAnswer();await peerConnection.setLocalDescription(a);await peerConnection.setRemoteDescription(a);*/}catch(err){console.error("Video call error:",err);videoStatusEl.textContent=`Error: ${err.message}`;setTimeout(stopVideoCall, 3000);}}
        function stopVideoCall() {isVideoCallActive=false;videoCallOverlay.classList.remove('active');if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null;}if(peerConnection){peerConnection.close();peerConnection=null;}localVideoEl.srcObject=null;remoteVideoEl.srcObject=null;videoStatusEl.textContent="Call Ended";}
        function toggleMic() {if(!localStream)return;const at=localStream.getAudioTracks()[0];if(at){at.enabled=!at.enabled;micToggleBtn.innerHTML=at.enabled?feather.icons['mic'].toSvg():feather.icons['mic-off'].toSvg();}}
        function toggleVideo() {if(!localStream)return;const vt=localStream.getVideoTracks()[0];if(vt){vt.enabled=!vt.enabled;videoToggleBtn.innerHTML=vt.enabled?feather.icons['video'].toSvg():feather.icons['video-off'].toSvg();localVideoEl.style.visibility=vt.enabled?'visible':'hidden';}}

        // --- Event Listeners Setup ---
        if (toggleSidebarBtn && contactListContainerEl) {
            toggleSidebarBtn.addEventListener('click', () => {
                contactListContainerEl.classList.toggle('collapsed');
                const isCollapsed = contactListContainerEl.classList.contains('collapsed');
                toggleSidebarBtn.innerHTML = isCollapsed ? feather.icons['arrow-right-circle'].toSvg() : feather.icons['arrow-left-circle'].toSvg();
            });
        }

        const debouncedSearch = debounce(handleContactSearch, 250);
        if (searchContactsInput) {
            searchContactsInput.addEventListener('input', debouncedSearch);
            searchContactsInput.addEventListener('keydown', function(e) {
                 if (e.key === 'Escape') {
                     this.value = '';
                     handleContactSearch(); // Re-render full list
                 }
             });
        }

        navTabs.forEach(tab => tab.addEventListener('click', () => switchView(tab.dataset.view)));
        sendButton.addEventListener('click', () => sendMessage(messageInputEl.value.trim()));
        messageInputEl.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(messageInputEl.value.trim()); }});
        attachImageChatBtn.addEventListener('click', () => imageUploadChatInput.click());
        imageUploadChatInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => sendMessage(messageInputEl.value.trim(), e.target.result); reader.readAsDataURL(file); }});
        submitPostButton.addEventListener('click', () => { const file = createPostImageInput.files[0]; const caption = createPostCaptionInput.value.trim(); if (file) { const reader = new FileReader(); reader.onload = (e) => createPost(e.target.result, caption); reader.readAsDataURL(file); } else { createPost(null, caption); }});
        feedContainerEl.addEventListener('click', (e) => { const btn = e.target.closest('.like-button'); if (btn) toggleLike(btn.dataset.postId); });
        saveEncryptionKeyBtn.addEventListener('click', () => { const newKey = encryptionKeyInput.value; if (newKey) { encryptionKey = newKey; localStorage.setItem('chatEncryptionKey', encryptionKey); alert("Client-side encryption key set/updated."); } else { encryptionKey = null; localStorage.removeItem('chatEncryptionKey'); alert("Client-side encryption key cleared."); } updateEncryptionKeyStatus(); if(activeChatContactId) renderMessages(); });
        callButton.addEventListener('click', () => { if (activeChatContactId && masterContacts.find(c => c.id === activeChatContactId)?.name !== 'Echo Bot') startVideoCall(); });
        endCallBtn.addEventListener('click', stopVideoCall); micToggleBtn.addEventListener('click', toggleMic); videoToggleBtn.addEventListener('click', toggleVideo); closeGameButton.addEventListener('click', closeGame);

        // --- Initial Setup ---
        updateEncryptionKeyStatus();
        // Populate games if newGamesData is provided by user
        if (typeof newGamesData !== 'undefined' && Array.isArray(newGamesData) && newGamesData.length > 0) {
             games = newGamesData.map((game, index) => ({ id: `game_${index}`, name: game.title, url: game.embed, thumbnailUrl: game.image }));
        } else {
            console.warn("`newGamesData` is empty or not provided. Games list will be empty.");
            games = [];
        }
        switchView('chat'); // Set initial view

    });
    </script>
</body>
</html>
